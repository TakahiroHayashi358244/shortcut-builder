<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Shortcut Builder</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ”—</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root{--bg:#0f1117;--surface:#1a1d27;--surface2:#232733;--border:#2e3345;--text:#e4e6f0;--text2:#8b8fa7;--accent:#4f8cff;--accent2:#6c5ce7;--danger:#ff6b6b;--success:#51cf66;--radius:10px}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Noto Sans JP',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow:hidden}

.header{background:linear-gradient(135deg,#1a1d27,#232733);border-bottom:1px solid var(--border);padding:12px 20px;display:flex;align-items:center;justify-content:space-between;z-index:100;height:52px}
.header h1{font-size:16px;font-weight:700;display:flex;align-items:center;gap:10px}
.header h1::before{content:'';width:24px;height:24px;background:linear-gradient(135deg,var(--accent),var(--accent2));border-radius:6px;display:inline-block}
.header-actions{display:flex;gap:6px;flex-wrap:wrap;align-items:center}

.btn{font-family:inherit;font-size:12px;font-weight:500;padding:6px 14px;border:1px solid var(--border);border-radius:7px;background:var(--surface2);color:var(--text);cursor:pointer;transition:all .15s;display:inline-flex;align-items:center;gap:5px;white-space:nowrap}
.btn:hover{background:var(--border)}
.btn-primary{background:var(--accent);border-color:var(--accent);color:#fff}
.btn-primary:hover{background:#3d7aee}
.btn-save{background:#7c3aed;border-color:#7c3aed;color:#fff}
.btn-save:hover{background:#6d28d9}
.btn-load{background:#059669;border-color:#059669;color:#fff}
.btn-load:hover{background:#047857}
.btn-danger{border-color:var(--danger);color:var(--danger)}
.btn-danger:hover{background:rgba(255,107,107,.1)}
.btn-sm{padding:4px 8px;font-size:11px}
.btn:disabled{opacity:.5;cursor:not-allowed}
.btn-frame{background:#0e7490;border-color:#0e7490;color:#fff}
.btn-frame:hover{background:#0c6880}

.pin-display{font-family:'JetBrains Mono',monospace;font-size:13px;padding:5px 12px;background:var(--bg);border:1px solid var(--border);border-radius:7px;color:var(--accent);letter-spacing:3px;font-weight:600}

.app{display:flex;height:calc(100vh - 52px)}
.sidebar{width:300px;min-width:300px;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow-y:auto;z-index:50;transition:margin-left .25s ease,opacity .25s ease}
.sidebar.hidden{margin-left:-300px;opacity:0;pointer-events:none}
.sidebar-toggle{position:absolute;top:12px;left:12px;z-index:60;width:32px;height:32px;border-radius:7px;border:1px solid var(--border);background:var(--surface2);color:var(--text2);font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;line-height:1}
.sidebar-toggle:hover{background:var(--border);color:var(--text)}
.sidebar-toggle .arrow{transition:transform .25s ease;display:inline-block}
.sidebar.hidden~.canvas-wrapper .sidebar-toggle .arrow{transform:rotate(180deg)}
/* Sidebar tabs */
.sidebar-tabs{display:flex;border-bottom:1px solid var(--border);background:var(--bg)}
.sidebar-tab{flex:1;font-family:inherit;font-size:12px;font-weight:500;padding:10px 8px;border:none;background:none;color:var(--text2);cursor:pointer;transition:all .15s;border-bottom:2px solid transparent}
.sidebar-tab:hover{color:var(--text)}
.sidebar-tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.tab-content{flex:1;overflow-y:auto}

/* Background color grid */
.bg-color-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;padding:4px 0}
.bg-color-cell{height:40px;border-radius:8px;border:2px solid transparent;cursor:pointer;transition:all .15s;position:relative}
.bg-color-cell:hover{transform:scale(1.05);box-shadow:0 2px 8px rgba(0,0,0,.3)}
.bg-color-cell.active{border-color:#fff;box-shadow:0 0 0 2px var(--accent)}
.bg-color-cell .bg-label{position:absolute;bottom:2px;left:50%;transform:translateX(-50%);font-size:8px;color:rgba(255,255,255,.6);white-space:nowrap;text-shadow:0 1px 2px rgba(0,0,0,.5)}

.sidebar-section{padding:16px;border-bottom:1px solid var(--border)}
.sidebar-section h3{font-size:11px;font-weight:500;color:var(--text2);text-transform:uppercase;letter-spacing:1px;margin-bottom:12px}

.form-group{margin-bottom:12px}
.form-group label{display:block;font-size:11px;font-weight:500;color:var(--text2);margin-bottom:5px}
.form-group input,.form-group select{width:100%;font-family:inherit;font-size:13px;padding:8px 10px;background:var(--bg);border:1px solid var(--border);border-radius:7px;color:var(--text);outline:none;transition:border-color .15s}
.form-group input:focus,.form-group select:focus{border-color:var(--accent)}
.form-group input::placeholder{color:var(--text2);opacity:.5}

.color-row{display:flex;gap:5px;flex-wrap:wrap}
.color-swatch{width:26px;height:26px;border-radius:6px;border:2px solid transparent;cursor:pointer;transition:all .15s}
.color-swatch:hover{transform:scale(1.15)}
.color-swatch.active{border-color:#fff;box-shadow:0 0 0 2px var(--accent)}

.icon-row{display:flex;gap:5px;flex-wrap:wrap}
.icon-option{width:32px;height:32px;display:flex;align-items:center;justify-content:center;background:var(--bg);border:1px solid var(--border);border-radius:6px;cursor:pointer;font-size:15px;transition:all .15s}
.icon-option:hover{border-color:var(--accent)}
.icon-option.active{border-color:var(--accent);background:rgba(79,140,255,.15)}

.preview-area{padding:16px;display:flex;flex-direction:column;align-items:center;gap:8px}
.preview-label{font-size:10px;color:var(--text2);text-transform:uppercase;letter-spacing:1px}

.size-slider{width:100%;-webkit-appearance:none;height:4px;border-radius:2px;background:var(--border);outline:none}
.size-slider::-webkit-slider-thumb{-webkit-appearance:none;width:16px;height:16px;border-radius:50%;background:var(--accent);cursor:pointer}

.canvas-wrapper{flex:1;position:relative;overflow:hidden;display:flex;flex-direction:column}
.cat-tab-bar{display:flex;gap:0;background:var(--surface);border-bottom:1px solid var(--border);padding:0 48px;overflow-x:auto;flex-shrink:0;z-index:40}
.cat-tab-bar::-webkit-scrollbar{height:0}
.cat-tab{font-family:inherit;font-size:12px;font-weight:500;padding:8px 16px;border:none;background:none;color:var(--text2);cursor:pointer;white-space:nowrap;border-bottom:2px solid transparent;transition:all .15s}
.cat-tab:hover{color:var(--text)}
.cat-tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.cat-tab .cat-count{font-size:10px;margin-left:4px;padding:1px 5px;border-radius:8px;background:var(--border);color:var(--text2)}
.cat-tab.active .cat-count{background:rgba(79,140,255,.2);color:var(--accent)}
.canvas{flex:1;position:relative;overflow:auto}
.canvas::before{content:'';position:absolute;inset:0;width:5000px;height:5000px;background-image:radial-gradient(circle,var(--border) 1px,transparent 1px);background-size:40px 40px;pointer-events:none;opacity:.35}

/* â”€â”€ Group Frame â”€â”€ */
.group-frame{position:absolute;border-radius:12px;background:rgba(255,255,255,.06);z-index:2;min-width:100px;min-height:80px}
.group-frame .frame-tab{position:absolute;top:-1px;left:12px;transform:translateY(-100%);padding:4px 14px 3px;border-radius:7px 7px 0 0;font-size:12px;font-weight:600;letter-spacing:.3px;white-space:nowrap;cursor:grab;border-bottom:none}
.group-frame .frame-tab:active{cursor:grabbing}
.group-frame .frame-resize{position:absolute;right:-4px;bottom:-4px;width:16px;height:16px;cursor:nwse-resize;z-index:5;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .15s}
.group-frame:hover .frame-resize{opacity:1}
.group-frame .frame-resize::after{content:'';width:8px;height:8px;border-right:2px solid;border-bottom:2px solid;opacity:.5}
.group-frame .frame-actions{position:absolute;top:4px;right:4px;display:none;gap:2px;z-index:6}
.group-frame:hover .frame-actions{display:flex}
.frame-action-btn{width:20px;height:20px;border:none;border-radius:4px;background:rgba(0,0,0,.4);color:rgba(255,255,255,.6);font-size:10px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.frame-action-btn:hover{color:#fff;background:rgba(0,0,0,.6)}
.frame-action-btn.delete:hover{color:var(--danger)}

/* Shortcut Button */
.shortcut-btn{position:absolute;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;border-radius:var(--radius);border:1px solid rgba(255,255,255,.08);text-decoration:none;color:var(--text);user-select:none;z-index:10;overflow:hidden;transition:box-shadow .2s,transform .2s}
.shortcut-btn:hover{box-shadow:0 8px 28px rgba(0,0,0,.5);z-index:20}
.shortcut-btn.dragging{box-shadow:0 16px 48px rgba(0,0,0,.6);z-index:1000;transition:none;transform:scale(1.05)}
.shortcut-btn .link-zone{position:absolute;top:20%;left:20%;right:20%;bottom:20%;cursor:pointer;z-index:5;border-radius:6px;transition:background .15s}
.shortcut-btn .link-zone:hover{background:rgba(255,255,255,.08)}
.shortcut-btn .drag-zone{position:absolute;inset:0;cursor:grab;z-index:3}
.shortcut-btn.dragging .drag-zone{cursor:grabbing}
.shortcut-btn .drag-edge-indicator{position:absolute;inset:0;border:2px dashed transparent;border-radius:var(--radius);pointer-events:none;transition:border-color .2s;z-index:6}
.shortcut-btn:hover .drag-edge-indicator{border-color:rgba(255,255,255,.12)}
.shortcut-btn .sc-content{position:relative;z-index:4;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;pointer-events:none;width:100%;height:100%;padding:14px 10px}
.shortcut-btn .sc-icon{font-size:22px;width:40px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:9px;background:rgba(255,255,255,.15)}
.shortcut-btn .sc-name{font-weight:700;text-align:center;line-height:1.3;word-break:break-word;max-width:100%;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;text-shadow:0 1px 3px rgba(0,0,0,.4)}
.shortcut-btn .sc-category{font-size:8px;text-transform:uppercase;letter-spacing:.5px;opacity:.7}
.shortcut-btn .sc-actions{position:absolute;top:3px;right:3px;display:none;gap:2px;z-index:8}
.shortcut-btn:hover .sc-actions{display:flex}
.sc-action-btn{width:20px;height:20px;border:none;border-radius:4px;background:rgba(0,0,0,.5);color:rgba(255,255,255,.7);font-size:10px;cursor:pointer;display:flex;align-items:center;justify-content:center;pointer-events:auto}
.sc-action-btn:hover{color:#fff;background:rgba(0,0,0,.7)}
.sc-action-btn.delete:hover{color:var(--danger)}

.context-menu{display:none;position:fixed;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:4px;z-index:500;min-width:160px;box-shadow:0 12px 36px rgba(0,0,0,.5)}
.context-menu.show{display:block}
.context-menu-item{font-family:inherit;font-size:12px;padding:8px 12px;border:none;background:none;color:var(--text);cursor:pointer;width:100%;text-align:left;border-radius:5px;display:block}
.context-menu-item:hover{background:var(--border)}
.context-menu-item.danger{color:var(--danger)}

.canvas-info{position:absolute;bottom:12px;left:50%;transform:translateX(-50%);background:var(--surface2);border:1px solid var(--border);border-radius:20px;padding:6px 16px;font-size:11px;color:var(--text2);z-index:30;display:flex;gap:16px;align-items:center;pointer-events:none}

.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(4px);z-index:200;align-items:center;justify-content:center}
.modal-overlay.show{display:flex}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:14px;width:500px;max-width:92vw;max-height:85vh;overflow-y:auto;padding:24px}
.modal h2{font-size:15px;font-weight:700;margin-bottom:16px}
.modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:18px}

.pin-input-group{display:flex;gap:8px;justify-content:center;margin:16px 0}
.pin-digit{width:52px;height:60px;font-family:'JetBrains Mono',monospace;font-size:28px;font-weight:700;text-align:center;background:var(--bg);border:2px solid var(--border);border-radius:10px;color:var(--accent);outline:none;transition:border-color .2s}
.pin-digit:focus{border-color:var(--accent)}
.pin-status{text-align:center;font-size:12px;margin-top:8px;min-height:18px}
.pin-status.success{color:var(--success)}
.pin-status.error{color:var(--danger)}
.pin-status.loading{color:var(--accent)}

.toast-container{position:fixed;bottom:20px;right:20px;z-index:300;display:flex;flex-direction:column;gap:6px}
.toast{padding:10px 16px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;font-size:12px;animation:slideIn .3s ease;box-shadow:0 8px 24px rgba(0,0,0,.3)}
.toast.success{border-left:3px solid var(--success)}
.toast.error{border-left:3px solid var(--danger)}
@keyframes slideIn{from{transform:translateX(80px);opacity:0}to{transform:translateX(0);opacity:1}}

.cat-manage-row{display:flex;align-items:center;gap:8px;margin-bottom:6px;padding:6px 8px;background:var(--bg);border-radius:6px}
.cat-manage-row span{flex:1;font-size:13px}
.empty-hint{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;color:var(--text2);pointer-events:none;z-index:5}
.empty-hint .icon{font-size:48px;opacity:.2;margin-bottom:12px}
.empty-hint p{font-size:13px;opacity:.6;line-height:1.8}
.settings-btn{background:none;border:none;color:var(--text2);font-size:18px;cursor:pointer;padding:4px;transition:color .15s;line-height:1}
.settings-btn:hover{color:var(--text)}
.frame-color-row{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
.frame-color-opt{width:32px;height:32px;border-radius:6px;border:2px solid transparent;cursor:pointer;transition:all .15s}
.frame-color-opt:hover{transform:scale(1.1)}
.frame-color-opt.active{border-color:#fff;box-shadow:0 0 0 2px var(--accent)}

@media(max-width:768px){
  .app{flex-direction:column}
  .sidebar{width:100%;min-width:unset;max-height:45vh;border-right:none;border-bottom:1px solid var(--border)}
  .canvas-wrapper{min-height:55vh}
  .header-actions{gap:4px}
  .btn{font-size:11px;padding:5px 10px}
}
</style>
</head>
<body>

<div class="header">
  <div style="display:flex;align-items:center;gap:10px;">
    <h1>Shortcut Builder</h1>
    <div style="display:flex;gap:6px;align-items:center;margin-left:8px;">
      <button class="btn btn-primary" onclick="confirmNewLayout()">ï¼‹ æ–°è¦ä½œæˆ</button>
      <button class="btn" onclick="manageCats()">ã‚«ãƒ†ã‚´ãƒªãƒ¼ç®¡ç†</button>
      <button class="btn btn-frame" onclick="openFrameModal()">ã‚°ãƒ«ãƒ¼ãƒ—æ è¿½åŠ </button>
    </div>
  </div>
  <div class="header-actions">
    <button class="btn" onclick="importData()">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
    <button class="btn" onclick="exportJSON()">JSONä¿å­˜</button>
    <span style="width:1px;height:24px;background:var(--border);margin:0 4px"></span>
    <button class="btn btn-save" onclick="openSaveModal()">æ–°è¦ä¿å­˜</button>
    <button class="btn btn-save" onclick="confirmOverwrite()" id="updateBtn" style="display:none;background:#6d28d9;border-color:#6d28d9;">ä¸Šæ›¸ãæ›´æ–°</button>
    <button class="btn btn-load" onclick="openLoadModal()">ã‚¯ãƒ©ã‚¦ãƒ‰èª­è¾¼</button>
    <span id="currentPin" class="pin-display" style="display:none"></span>
    <button class="settings-btn" onclick="openSettingsModal()" title="è¨­å®š">âš™</button>
  </div>
</div>

<div class="app">
  <div class="sidebar">
    <div class="sidebar-tabs">
      <button class="sidebar-tab active" onclick="switchTab('shortcut')">ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ</button>
      <button class="sidebar-tab" onclick="switchTab('settings')">è¨­å®š</button>
    </div>
    <div class="tab-content" id="tabShortcut">
      <div class="sidebar-section">
        <div class="form-group"><label>ã‚«ãƒ†ã‚´ãƒªãƒ¼</label><select id="catSelect"></select></div>
        <div class="form-group"><label>ä½œæ¥­å</label><input type="text" id="scName" placeholder="ä¾‹: å‹¤æ€ ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ "></div>
        <div class="form-group"><label>URL</label><input type="text" id="scUrl" placeholder="https://..."></div>
      </div>
      <div class="sidebar-section">
        <div class="form-group"><div class="color-row" id="colorPicker"></div></div>
        <div class="form-group"><div class="icon-row" id="iconPicker"></div></div>
        <div class="form-group"><label>ãƒœã‚¿ãƒ³ã‚µã‚¤ã‚º: <span id="sizeLabel">120</span>px</label><input type="range" class="size-slider" id="sizeSlider" min="80" max="200" value="120"></div>
        <div class="form-group"><label>ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º: <span id="fontLabel">14</span>px</label><input type="range" class="size-slider" id="fontSlider" min="9" max="22" value="14"></div>
      </div>
      <div class="sidebar-section">
        <div class="preview-area">
          <span class="preview-label">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</span>
          <div id="previewBtn" style="position:relative;width:120px;height:120px;border-radius:10px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;border:1px solid rgba(255,255,255,.08);overflow:hidden;">
            <div class="sc-icon" id="previewIcon" style="font-size:22px;width:40px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:9px;background:rgba(255,255,255,.15);">ğŸ”—</div>
            <div id="previewName" style="font-size:14px;font-weight:700;text-align:center;text-shadow:0 1px 3px rgba(0,0,0,.4);">ä½œæ¥­å</div>
          </div>
        </div>
        <button class="btn btn-primary" style="width:100%;justify-content:center;" onclick="addShortcut()">è¿½åŠ ã™ã‚‹</button>
      </div>
    </div>
    <div class="tab-content" id="tabSettings" style="display:none;">
      <div class="sidebar-section">
        <h3>ã‚­ãƒ£ãƒ³ãƒã‚¹èƒŒæ™¯è‰²</h3>
        <div class="bg-color-grid" id="canvasBgPickerSidebar"></div>
      </div>
    </div>
  </div>
  <div class="canvas-wrapper">
    <button class="sidebar-toggle" onclick="toggleSidebar()" title="ã‚µã‚¤ãƒ‰ãƒãƒ¼è¡¨ç¤º/éè¡¨ç¤º"><span class="arrow">â—€</span></button>
    <div class="cat-tab-bar" id="catTabBar"></div>
    <div class="canvas" id="canvas"></div>
    <div class="canvas-info"><span id="countInfo">0 å€‹</span><span>ç«¯ãƒ‰ãƒ©ãƒƒã‚°=ç§»å‹•</span><span>ä¸­å¤®ã‚¯ãƒªãƒƒã‚¯=ãƒªãƒ³ã‚¯</span><span>å³ã‚¯ãƒªãƒƒã‚¯=ãƒ¡ãƒ‹ãƒ¥ãƒ¼</span></div>
  </div>
</div>

<!-- Context Menu -->
<div class="context-menu" id="contextMenu">
  <button class="context-menu-item" onclick="ctxOpen()">é–‹ã</button>
  <button class="context-menu-item" onclick="ctxEdit()">ç·¨é›†</button>
  <button class="context-menu-item" onclick="ctxDuplicate()">è¤‡è£½</button>
  <button class="context-menu-item danger" onclick="ctxDelete()">å‰Šé™¤</button>
</div>
<div class="context-menu" id="frameContextMenu">
  <button class="context-menu-item" onclick="fctxEdit()">æ ã‚’ç·¨é›†</button>
  <button class="context-menu-item danger" onclick="fctxDelete()">æ ã‚’å‰Šé™¤</button>
</div>

<!-- Category Modal -->
<div class="modal-overlay" id="catModal"><div class="modal">
  <h2>ã‚«ãƒ†ã‚´ãƒªãƒ¼ç®¡ç†</h2><div id="catList"></div>
  <div style="display:flex;gap:8px;margin-top:12px;"><input type="text" id="newCatInput" placeholder="æ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªãƒ¼å" style="flex:1;font-family:inherit;font-size:13px;padding:8px 10px;background:var(--bg);border:1px solid var(--border);border-radius:7px;color:var(--text);outline:none;"><button class="btn btn-primary" onclick="addCategory()">è¿½åŠ </button></div>
  <div class="modal-actions"><button class="btn" onclick="closeCatModal()">é–‰ã˜ã‚‹</button></div>
</div></div>

<!-- Edit Shortcut Modal -->
<div class="modal-overlay" id="editModal"><div class="modal">
  <h2>ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆç·¨é›†</h2>
  <div class="form-group"><label>ã‚«ãƒ†ã‚´ãƒªãƒ¼</label><select id="editCat"></select></div>
  <div class="form-group"><label>ä½œæ¥­å</label><input type="text" id="editName"></div>
  <div class="form-group"><label>URL</label><input type="text" id="editUrl"></div>
  <div class="form-group"><label>ã‚«ãƒ©ãƒ¼</label><div class="color-row" id="editColorPicker"></div></div>
  <div class="form-group"><label>ã‚¢ã‚¤ã‚³ãƒ³</label><div class="icon-row" id="editIconPicker"></div></div>
  <div class="form-group"><label>ã‚µã‚¤ã‚º: <span id="editSizeLabel">120</span>px</label><input type="range" class="size-slider" id="editSizeSlider" min="80" max="200" value="120"></div>
  <div class="form-group"><label>ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º: <span id="editFontLabel">14</span>px</label><input type="range" class="size-slider" id="editFontSlider" min="9" max="22" value="14"></div>
  <div class="modal-actions"><button class="btn btn-danger" onclick="deleteEditing()">å‰Šé™¤</button><button class="btn" onclick="closeEditModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button class="btn btn-primary" onclick="saveEdit()">ä¿å­˜</button></div>
</div></div>

<!-- Add/Edit Frame Modal -->
<div class="modal-overlay" id="frameModal"><div class="modal">
  <h2 id="frameModalTitle">ã‚°ãƒ«ãƒ¼ãƒ—æ ã‚’è¿½åŠ </h2>
  <div class="form-group"><label>ã‚°ãƒ«ãƒ¼ãƒ—å</label><input type="text" id="frameName" placeholder="ä¾‹: å‹¤æ€ é–¢é€£"></div>
  <div class="form-group"><label>æ ã‚«ãƒ©ãƒ¼</label><div class="frame-color-row" id="frameColorPicker"></div></div>
  <div class="form-group"><label>ç·šã®å¤ªã•: <span id="frameBorderLabel">3</span>px</label><input type="range" class="size-slider" id="frameBorderSlider" min="1" max="8" value="3"></div>
  <div class="modal-actions"><button class="btn" onclick="closeFrameModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button class="btn btn-frame" id="frameSubmitBtn" onclick="submitFrame()">è¿½åŠ </button></div>
</div></div>

<!-- Settings Modal -->
<div class="modal-overlay" id="settingsModal"><div class="modal">
  <h2>è¨­å®š</h2>
  <div class="form-group"><label>GAS API URL</label><input type="text" id="gasUrlInput" placeholder="https://script.google.com/macros/s/XXXX/exec"></div>
  <p style="font-size:11px;color:var(--text2);margin-top:4px;line-height:1.6;">Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ + Apps Script ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸURLã‚’è¨­å®š</p>
  <div class="form-group" style="margin-top:16px;"><label>ã‚­ãƒ£ãƒ³ãƒã‚¹èƒŒæ™¯è‰²</label><div class="bg-color-row" id="canvasBgPicker"></div></div>
  <div class="modal-actions"><button class="btn" onclick="closeSettingsModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button class="btn btn-primary" onclick="saveSettings()">ä¿å­˜</button></div>
</div></div>

<!-- Save Modal -->
<div class="modal-overlay" id="saveModal"><div class="modal" style="text-align:center;">
  <h2>ãƒã‚¤ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’ä¿å­˜</h2>
  <p style="font-size:12px;color:var(--text2);margin-bottom:8px;">4æ¡ã®PINã‚³ãƒ¼ãƒ‰ã‚’è¨­å®š<br>ã“ã®PINã§ä»–ã®PCã‹ã‚‰ã‚‚å‘¼ã³å‡ºã›ã¾ã™</p>
  <div class="pin-input-group" id="savePinGroup"><input type="text" class="pin-digit" maxlength="1" inputmode="numeric"><input type="text" class="pin-digit" maxlength="1" inputmode="numeric"><input type="text" class="pin-digit" maxlength="1" inputmode="numeric"><input type="text" class="pin-digit" maxlength="1" inputmode="numeric"></div>
  <div class="pin-status" id="saveStatus"></div>
  <div class="modal-actions" style="justify-content:center;"><button class="btn" onclick="closeSaveModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button class="btn btn-save" id="saveBtn" onclick="doCloudSave()">æ–°è¦ä¿å­˜</button></div>
</div></div>

<!-- Load Modal -->
<div class="modal-overlay" id="loadModal"><div class="modal" style="text-align:center;">
  <h2>ãƒã‚¤ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’èª­ã¿è¾¼ã¿</h2>
  <p style="font-size:12px;color:var(--text2);margin-bottom:8px;">ä¿å­˜æ™‚ã®4æ¡PINã‚’å…¥åŠ›</p>
  <div class="pin-input-group" id="loadPinGroup"><input type="text" class="pin-digit" maxlength="1" inputmode="numeric"><input type="text" class="pin-digit" maxlength="1" inputmode="numeric"><input type="text" class="pin-digit" maxlength="1" inputmode="numeric"><input type="text" class="pin-digit" maxlength="1" inputmode="numeric"></div>
  <div class="pin-status" id="loadStatus"></div>
  <div class="modal-actions" style="justify-content:center;"><button class="btn" onclick="closeLoadModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button class="btn btn-load" id="loadBtn" onclick="doCloudLoad()">èª­ã¿è¾¼ã‚€</button></div>
</div></div>

<!-- Overwrite Confirm Modal -->
<div class="modal-overlay" id="overwriteConfirmModal"><div class="modal" style="text-align:center;">
  <h2>ä¸Šæ›¸ãæ›´æ–°ã®ç¢ºèª</h2>
  <p style="font-size:13px;color:var(--text2);margin-bottom:6px;line-height:1.8;">PIN: <span id="overwritePinDisplay" style="font-family:'JetBrains Mono',monospace;color:var(--accent);font-weight:700;letter-spacing:2px;"></span></p>
  <p style="font-size:13px;color:var(--danger);margin-bottom:16px;line-height:1.8;">æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ãŒä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚<br>ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚</p>
  <div style="display:flex;gap:8px;justify-content:center;">
    <button class="btn" onclick="closeOverwriteConfirm()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    <button class="btn btn-save" style="background:#6d28d9;border-color:#6d28d9;" onclick="closeOverwriteConfirm();doCloudUpdate();">ä¸Šæ›¸ãã™ã‚‹</button>
  </div>
</div></div>

<!-- Import Modal -->
<div class="modal-overlay" id="importModal"><div class="modal">

<!-- New Layout Confirm Modal -->
</div></div>
<div class="modal-overlay" id="newConfirmModal"><div class="modal" style="text-align:center;">
  <h2>æ–°è¦ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’ä½œæˆ</h2>
  <p style="font-size:13px;color:var(--text2);margin-bottom:16px;line-height:1.8;">ç¾åœ¨ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’ã©ã†ã—ã¾ã™ã‹?</p>
  <div style="display:flex;flex-direction:column;gap:8px;max-width:280px;margin:0 auto;">
    <button class="btn btn-save" style="justify-content:center;padding:10px 16px;" onclick="newWithSave()">ä¿å­˜ã—ã¦ã‹ã‚‰æ–°è¦ä½œæˆ</button>
    <button class="btn btn-danger" style="justify-content:center;padding:10px 16px;" onclick="newWithoutSave()">ä¿å­˜ã›ãšã«æ–°è¦ä½œæˆ</button>
    <button class="btn" style="justify-content:center;padding:10px 16px;" onclick="closeNewConfirm()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>
</div></div>
<div class="modal-overlay" id="importModal"><div class="modal">
  <h2>ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h2>
  <p style="font-size:12px;color:var(--text2);margin-bottom:12px;">JSONãƒ•ã‚¡ã‚¤ãƒ«ã¾ãŸã¯ãƒ†ã‚­ã‚¹ãƒˆ</p>
  <input type="file" id="importFile" accept=".json" style="margin-bottom:10px;font-size:12px;color:var(--text);">
  <textarea id="importText" rows="6" placeholder="JSONãƒ†ã‚­ã‚¹ãƒˆ..." style="width:100%;font-family:'JetBrains Mono',monospace;font-size:11px;padding:10px;background:var(--bg);border:1px solid var(--border);border-radius:7px;color:var(--text);outline:none;resize:vertical;"></textarea>
  <div class="modal-actions"><button class="btn" onclick="closeImportModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button class="btn btn-primary" onclick="doImport()">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button></div>
</div></div>

<div class="toast-container" id="toastContainer"></div>

<script>
const DEFAULT_GAS_URL='https://script.google.com/macros/s/AKfycbwawYZmDBj2GtwF7huYO8LLQG4IqUnotxs1M6A6Lk9F-PDnMF8KsYqIfeju4zJUHr0L/exec';

const COLORS=['#FFFFFF','#2D2D2D','#808080','#C0C0C0','#FF2D87','#FF69B4','#FF8C00','#FFA500','#FFD60A','#FFEB3B','#4CD964','#34C759','#00C853','#2DD4BF','#00BCD4','#29B6F6','#2196F3','#1E90FF','#536DFE','#7C4DFF','#AB47BC','#E040FB','#FF4081','#FF1744'];
const ICONS=['â­','â¤ï¸','ğŸ”¥','âš¡','ğŸ¯','âœ…','ğŸš€','ğŸ’¡','ğŸ ','ğŸ“Š','ğŸ“','ğŸ“§','ğŸ”§','ğŸ“±','ğŸ’¼','ğŸ“…','ğŸ”','ğŸ›’','ğŸ’°','â˜ï¸','ğŸŒ'];
const FRAME_COLORS=['#4f8cff','#6c5ce7','#00b894','#e17055','#fdcb6e','#fd79a8','#00cec9','#636e72','#a29bfe','#d63031','#0984e3','#e84393'];

// Canvas background colors (10 colors)
const BG_COLORS=[
  {color:'#0f1117',label:'ãƒ–ãƒ©ãƒƒã‚¯'},
  {color:'#1a1a2e',label:'ãƒ€ãƒ¼ã‚¯ãƒã‚¤ãƒ“ãƒ¼'},
  {color:'#dfe6e9',label:'ãƒ©ã‚¤ãƒˆã‚°ãƒ¬ãƒ¼'},
  {color:'#ffeef2',label:'è–„ãƒ”ãƒ³ã‚¯'},
  {color:'#fff9e6',label:'è–„ã‚¤ã‚¨ãƒ­ãƒ¼'},
  {color:'#e8f5e9',label:'è–„ã‚°ãƒªãƒ¼ãƒ³'},
  {color:'#e3f2fd',label:'è–„ãƒ–ãƒ«ãƒ¼'},
  {color:'#f3e5f5',label:'è–„ãƒ‘ãƒ¼ãƒ—ãƒ«'},
  {color:'#f48fb1',label:'ãƒ”ãƒ³ã‚¯'},
  {color:'#fdd835',label:'ã‚¤ã‚¨ãƒ­ãƒ¼'}
];

let state={categories:['æ¥­å‹™ã‚·ã‚¹ãƒ†ãƒ ','ç®¡ç†ãƒ„ãƒ¼ãƒ«','å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹'],shortcuts:[],frames:[],nextId:1,nextFrameId:1,canvasBg:'#0f1117'};
let selectedColor=COLORS[0],selectedIcon=ICONS[0],editColor=COLORS[0],editIcon=ICONS[0];
let editingId=null,ctxTargetId=null,fctxTargetId=null;
let isDragging=false,dragEl=null,dragId=null,dragOffsetX=0,dragOffsetY=0,dragType=null;
let isResizing=false,resizeEl=null,resizeId=null,resizeStartX=0,resizeStartY=0,resizeStartW=0,resizeStartH=0;
let currentPin=null,GAS_URL='';
let frameEditId=null,frameSelectedColor=FRAME_COLORS[0],frameBorderWidth=3;
let activeFilter='all'; // category filter

function init(){
  loadGasUrl();loadFromStorage();
  if(!state.frames) state.frames=[];
  if(!state.nextFrameId) state.nextFrameId=1;
  if(!state.canvasBg) state.canvasBg='#0f1117';
  applyCanvasBg();
  buildPickers();buildCanvasBgPicker();
  populateCatSelect();buildCatTabs();renderCanvas();updatePreview();updateCount();
  setupPinInputs('savePinGroup');setupPinInputs('loadPinGroup');
  document.getElementById('scName').addEventListener('input',updatePreview);
  document.getElementById('sizeSlider').addEventListener('input',e=>{document.getElementById('sizeLabel').textContent=e.target.value;updatePreview();});
  document.getElementById('fontSlider').addEventListener('input',e=>{document.getElementById('fontLabel').textContent=e.target.value;updatePreview();});
  document.getElementById('editSizeSlider').addEventListener('input',e=>{document.getElementById('editSizeLabel').textContent=e.target.value;});
  document.getElementById('editFontSlider').addEventListener('input',e=>{document.getElementById('editFontLabel').textContent=e.target.value;});
  document.getElementById('frameBorderSlider').addEventListener('input',e=>{document.getElementById('frameBorderLabel').textContent=e.target.value;});
  document.addEventListener('click',()=>{hideContextMenu();hideFrameContextMenu();});
  document.addEventListener('mousemove',onMM);document.addEventListener('mouseup',onMU);
  document.addEventListener('touchmove',onTM,{passive:false});document.addEventListener('touchend',onTE);
  if(!GAS_URL) setTimeout(()=>toast('å³ä¸Šã® âš™ ã‹ã‚‰GAS API URLã‚’è¨­å®š','error'),500);
}

function applyCanvasBg(){document.querySelector('.canvas-wrapper').style.background=state.canvasBg||'#0f1117';}

// â”€â”€ GAS URL & Settings â”€â”€
function loadGasUrl(){GAS_URL=localStorage.getItem('sb_gas_url')||DEFAULT_GAS_URL;document.getElementById('gasUrlInput').value=GAS_URL;}
function openSettingsModal(){document.getElementById('gasUrlInput').value=GAS_URL;buildBgPicker('canvasBgPicker',state.canvasBg||'#0f1117',c=>{state.canvasBg=c;applyCanvasBg();saveToStorage();buildBgPicker('canvasBgPicker',state.canvasBg);buildCanvasBgPicker();});document.getElementById('settingsModal').classList.add('show');}
function closeSettingsModal(){document.getElementById('settingsModal').classList.remove('show');}
function saveSettings(){GAS_URL=document.getElementById('gasUrlInput').value.trim();localStorage.setItem('sb_gas_url',GAS_URL);saveToStorage();closeSettingsModal();toast('è¨­å®šã‚’ä¿å­˜','success');}

// â”€â”€ Canvas BG Picker in sidebar â”€â”€
function buildCanvasBgPicker(){buildBgPicker('canvasBgPickerSidebar',state.canvasBg||'#0f1117',c=>{state.canvasBg=c;applyCanvasBg();saveToStorage();buildCanvasBgPicker();});}

// â”€â”€ New Layout â”€â”€
function confirmNewLayout(){
  if(state.shortcuts.length||( state.frames&&state.frames.length)){document.getElementById('newConfirmModal').classList.add('show');}
  else resetLayout();
}
function closeNewConfirm(){document.getElementById('newConfirmModal').classList.remove('show');}
function newWithSave(){closeNewConfirm();if(currentPin){doCloudUpdate().then(()=>resetLayout());}else openSaveModal();}
function newWithoutSave(){closeNewConfirm();resetLayout();}
function resetLayout(){
  state.shortcuts=[];state.frames=[];state.nextId=1;state.nextFrameId=1;
  currentPin=null;document.getElementById('currentPin').style.display='none';document.getElementById('updateBtn').style.display='none';
  saveToStorage();renderCanvas();updateCount();toast('æ–°è¦ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’ä½œæˆ','success');
}

// â”€â”€ Storage â”€â”€
function saveToStorage(){try{localStorage.setItem('sb_v7',JSON.stringify(state));}catch(e){}}
function loadFromStorage(){try{const d=localStorage.getItem('sb_v7');if(d)state=JSON.parse(d);}catch(e){}}

// â”€â”€ PIN â”€â”€
function setupPinInputs(gid){const inputs=document.getElementById(gid).querySelectorAll('.pin-digit');inputs.forEach((inp,i)=>{inp.addEventListener('input',()=>{inp.value=inp.value.replace(/\D/g,'').slice(0,1);if(inp.value&&i<3)inputs[i+1].focus();});inp.addEventListener('keydown',e=>{if(e.key==='Backspace'&&!inp.value&&i>0){inputs[i-1].focus();inputs[i-1].value='';}});inp.addEventListener('paste',e=>{e.preventDefault();const p=(e.clipboardData||window.clipboardData).getData('text').replace(/\D/g,'').slice(0,4);p.split('').forEach((ch,j)=>{if(inputs[j])inputs[j].value=ch;});if(p.length>0)inputs[Math.min(p.length,3)].focus();});});}
function getPinFromGroup(gid){return Array.from(document.getElementById(gid).querySelectorAll('.pin-digit')).map(i=>i.value).join('');}
function clearPinGroup(gid){document.getElementById(gid).querySelectorAll('.pin-digit').forEach(i=>i.value='');}

// â”€â”€ Cloud â”€â”€
function openSaveModal(){if(!GAS_URL){toast('API URLæœªè¨­å®š','error');return;}clearPinGroup('savePinGroup');document.getElementById('saveStatus').textContent='';document.getElementById('saveModal').classList.add('show');setTimeout(()=>document.getElementById('savePinGroup').querySelector('.pin-digit').focus(),100);}
function closeSaveModal(){document.getElementById('saveModal').classList.remove('show');}
async function doCloudSave(){const pin=getPinFromGroup('savePinGroup');if(pin.length!==4){setStatus('saveStatus','4æ¡å…¥åŠ›','error');return;}document.getElementById('saveBtn').disabled=true;setStatus('saveStatus','ä¿å­˜ä¸­...','loading');try{const res=await fetch(GAS_URL,{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify({action:'save',pin,data:state})});const json=await res.json();if(json.success){currentPin=pin;document.getElementById('currentPin').textContent='PIN: '+pin;document.getElementById('currentPin').style.display='inline-block';document.getElementById('updateBtn').style.display='inline-flex';setStatus('saveStatus',json.message,'success');toast('ä¿å­˜ã—ã¾ã—ãŸ (PIN: '+pin+')','success');setTimeout(closeSaveModal,1200);}else setStatus('saveStatus',json.error||'ä¿å­˜å¤±æ•—','error');}catch(err){setStatus('saveStatus','é€šä¿¡ã‚¨ãƒ©ãƒ¼','error');}document.getElementById('saveBtn').disabled=false;}
async function doCloudUpdate(){if(!currentPin){toast('å…ˆã«ä¿å­˜/èª­è¾¼','error');return;}if(!GAS_URL){toast('API URLæœªè¨­å®š','error');return;}toast('æ›´æ–°ä¸­...','success');try{const res=await fetch(GAS_URL,{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify({action:'overwrite',pin:currentPin,data:state})});const json=await res.json();if(json.success)toast('PIN: '+currentPin+' ä¸Šæ›¸ãæ›´æ–°','success');else toast(json.error||'æ›´æ–°å¤±æ•—','error');}catch(err){toast('é€šä¿¡ã‚¨ãƒ©ãƒ¼','error');}}
function confirmOverwrite(){if(!currentPin){toast('å…ˆã«ä¿å­˜/èª­è¾¼','error');return;}document.getElementById('overwritePinDisplay').textContent=currentPin;document.getElementById('overwriteConfirmModal').classList.add('show');}
function closeOverwriteConfirm(){document.getElementById('overwriteConfirmModal').classList.remove('show');}
function openLoadModal(){if(!GAS_URL){toast('API URLæœªè¨­å®š','error');return;}clearPinGroup('loadPinGroup');document.getElementById('loadStatus').textContent='';document.getElementById('loadModal').classList.add('show');setTimeout(()=>document.getElementById('loadPinGroup').querySelector('.pin-digit').focus(),100);}
function closeLoadModal(){document.getElementById('loadModal').classList.remove('show');}
async function doCloudLoad(){const pin=getPinFromGroup('loadPinGroup');if(pin.length!==4){setStatus('loadStatus','4æ¡å…¥åŠ›','error');return;}document.getElementById('loadBtn').disabled=true;setStatus('loadStatus','èª­ã¿è¾¼ã¿ä¸­...','loading');try{const res=await fetch(GAS_URL,{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify({action:'load',pin})});const json=await res.json();if(json.success){state=json.data;if(!state.frames)state.frames=[];if(!state.nextFrameId)state.nextFrameId=1;if(!state.canvasBg)state.canvasBg='#0f1117';applyCanvasBg();saveToStorage();populateCatSelect();buildCatTabs();renderCanvas();updateCount();currentPin=pin;document.getElementById('currentPin').textContent='PIN: '+pin;document.getElementById('currentPin').style.display='inline-block';document.getElementById('updateBtn').style.display='inline-flex';setStatus('loadStatus','èª­ã¿è¾¼ã¿å®Œäº†','success');toast('èª­ã¿è¾¼ã¿ã¾ã—ãŸ','success');setTimeout(closeLoadModal,1200);}else setStatus('loadStatus',json.error||'å¤±æ•—','error');}catch(err){setStatus('loadStatus','é€šä¿¡ã‚¨ãƒ©ãƒ¼','error');}document.getElementById('loadBtn').disabled=false;}
function setStatus(id,msg,type){const el=document.getElementById(id);el.textContent=msg;el.className='pin-status '+type;}

// â”€â”€ Pickers â”€â”€
function buildPickers(){rCP('colorPicker',selectedColor,c=>{selectedColor=c;buildPickers();updatePreview();});rIP('iconPicker',selectedIcon,i=>{selectedIcon=i;buildPickers();updatePreview();});}
function rCP(id,act,cb){const el=document.getElementById(id);el.innerHTML='';COLORS.forEach(c=>{const s=document.createElement('div');s.className='color-swatch'+(c===act?' active':'');s.style.background=c;s.onclick=()=>cb(c);el.appendChild(s);});}
function rIP(id,act,cb){const el=document.getElementById(id);el.innerHTML='';ICONS.forEach(ic=>{const s=document.createElement('div');s.className='icon-option'+(ic===act?' active':'');s.textContent=ic;s.onclick=()=>cb(ic);el.appendChild(s);});}
function buildBgPicker(id,act,cb){const el=document.getElementById(id);if(!el)return;el.innerHTML='';BG_COLORS.forEach(bg=>{const s=document.createElement('div');s.className='bg-color-cell'+(bg.color===act?' active':'');s.style.background=bg.color;if(bg.color==='#ffffff'&&!s.classList.contains('active'))s.style.borderColor='#ddd';s.innerHTML='<span class="bg-label">'+bg.label+'</span>';s.onclick=()=>{if(cb)cb(bg.color);};el.appendChild(s);});}
function populateCatSelect(){['catSelect','editCat'].forEach(id=>{const s=document.getElementById(id);if(!s)return;s.innerHTML='';state.categories.forEach(c=>{const o=document.createElement('option');o.value=c;o.textContent=c;s.appendChild(o);});});buildCatTabs();}

// â”€â”€ Preview â”€â”€
function updatePreview(){
  const nm=document.getElementById('scName').value||'ä½œæ¥­å',sz=parseInt(document.getElementById('sizeSlider').value),fs=parseInt(document.getElementById('fontSlider').value);
  const p=document.getElementById('previewBtn');
  p.style.width=sz+'px';p.style.height=sz+'px';
  p.style.background=`linear-gradient(145deg,${selectedColor}DD,${selectedColor}88)`;
  document.getElementById('previewName').textContent=nm;
  document.getElementById('previewName').style.fontSize=fs+'px';
  document.getElementById('previewIcon').textContent=selectedIcon;
}

// â”€â”€ Add Shortcut â”€â”€
function addShortcut(){
  const cat=document.getElementById('catSelect').value,name=document.getElementById('scName').value.trim(),url=document.getElementById('scUrl').value.trim();
  const size=parseInt(document.getElementById('sizeSlider').value),fontSize=parseInt(document.getElementById('fontSlider').value);
  if(!name){toast('ä½œæ¥­åã‚’å…¥åŠ›','error');return;}
  if(!url){toast('URLã‚’å…¥åŠ›','error');return;}
  const pos=findFree(size);
  state.shortcuts.push({id:state.nextId++,category:cat,name,url,color:selectedColor,icon:selectedIcon,x:pos.x,y:pos.y,w:size,h:size,fontSize:fontSize});
  saveToStorage();renderCanvas();updateCount();
  document.getElementById('scName').value='';document.getElementById('scUrl').value='';
  updatePreview();toast('è¿½åŠ ã—ã¾ã—ãŸ','success');
}
function findFree(sz){const cv=document.getElementById('canvas'),cw=cv.clientWidth||800,gap=16,cols=Math.max(1,Math.floor(cw/(sz+gap)));for(let r=0;r<200;r++)for(let c=0;c<cols;c++){const x=gap+c*(sz+gap),y=gap+r*(sz+gap);if(!state.shortcuts.some(s=>!(x+sz<s.x||x>s.x+(s.w||120)||y+sz<s.y||y>s.y+(s.h||120))))return{x,y};}return{x:16,y:16};}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ CATEGORY TABS â”€â”€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildCatTabs(){
  const bar=document.getElementById('catTabBar');bar.innerHTML='';
  const allCount=state.shortcuts.length;
  const allTab=document.createElement('button');allTab.className='cat-tab'+(activeFilter==='all'?' active':'');
  allTab.innerHTML='ã™ã¹ã¦<span class="cat-count">'+allCount+'</span>';
  allTab.onclick=()=>setFilter('all');bar.appendChild(allTab);
  state.categories.forEach(cat=>{
    const cnt=state.shortcuts.filter(s=>s.category===cat).length;
    const t=document.createElement('button');t.className='cat-tab'+(activeFilter===cat?' active':'');
    t.innerHTML=esc(cat)+'<span class="cat-count">'+cnt+'</span>';
    t.onclick=()=>setFilter(cat);bar.appendChild(t);
  });
}
function setFilter(cat){activeFilter=cat;buildCatTabs();renderCanvas();}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ RENDER â”€â”€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderCanvas(){
  const cv=document.getElementById('canvas');
  cv.querySelectorAll('.shortcut-btn,.empty-hint,.group-frame').forEach(e=>e.remove());

  // Frames (always show on 'all', hide on category filter)
  if(activeFilter==='all'){
    (state.frames||[]).forEach(f=>{
      const el=document.createElement('div');el.className='group-frame';el.dataset.fid=f.id;
      const col=f.color||FRAME_COLORS[0],bw=f.borderWidth||3;
      el.style.cssText=`left:${f.x}px;top:${f.y}px;width:${f.w}px;height:${f.h}px;border:${bw}px solid ${col}55;`;
      el.innerHTML=`<div class="frame-tab" style="background:${col}22;color:${col};border:${bw}px solid ${col}55;border-bottom:none;">${esc(f.name)}</div><div class="frame-actions"><button class="frame-action-btn" onclick="event.stopPropagation();editFrame(${f.id})" title="ç·¨é›†">âœ</button><button class="frame-action-btn delete" onclick="event.stopPropagation();deleteFrame(${f.id})" title="å‰Šé™¤">âœ•</button></div><div class="frame-resize" data-fid="${f.id}"></div>`;
      const tab=el.querySelector('.frame-tab');
      tab.addEventListener('mousedown',e=>{if(e.button===2)return;e.preventDefault();startDrag(el,e.clientX,e.clientY,'frame');});
      tab.addEventListener('touchstart',e=>{e.preventDefault();startDrag(el,e.touches[0].clientX,e.touches[0].clientY,'frame');},{passive:false});
      const rh=el.querySelector('.frame-resize');
      rh.addEventListener('mousedown',e=>{e.preventDefault();e.stopPropagation();startResize(el,f.id,e.clientX,e.clientY);});
      rh.addEventListener('touchstart',e=>{e.preventDefault();e.stopPropagation();startResize(el,f.id,e.touches[0].clientX,e.touches[0].clientY);},{passive:false});
      el.addEventListener('contextmenu',e=>{if(e.target.closest('.frame-action-btn'))return;e.preventDefault();e.stopPropagation();fctxTargetId=f.id;showFrameCtx(e.clientX,e.clientY);});
      cv.appendChild(el);
    });
  }

  // Filter shortcuts by category
  const filtered=activeFilter==='all'?state.shortcuts:state.shortcuts.filter(s=>s.category===activeFilter);

  if(!filtered.length&&(activeFilter!=='all'||!(state.frames||[]).length)){const h=document.createElement('div');h.className='empty-hint';h.innerHTML=activeFilter==='all'?'<div class="icon">ğŸ“Œ</div><p>ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã€Œï¼‹ æ–°è¦ä½œæˆã€ã‹ã‚‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚’è¿½åŠ </p>':'<div class="icon">ğŸ“‚</div><p>ã“ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã«ã¯ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“</p>';cv.appendChild(h);return;}
  filtered.forEach(s=>{
    const el=document.createElement('div'),w=s.w||120,h=s.h||120,fs=s.fontSize||14;
    const light=isLight(s.color);
    const txtCol=light?'#1a1a2e':'#fff';
    const txtShadow=light?'0 1px 2px rgba(0,0,0,.1)':'0 1px 3px rgba(0,0,0,.4)';
    const iconBg=light?'rgba(0,0,0,.1)':'rgba(255,255,255,.15)';
    el.className='shortcut-btn';el.dataset.id=s.id;
    el.style.cssText=`left:${s.x}px;top:${s.y}px;width:${w}px;height:${h}px;background:linear-gradient(145deg,${s.color}DD,${s.color}88);color:${txtCol};`;
    el.innerHTML=`<div class="drag-zone"></div><div class="link-zone"></div><div class="drag-edge-indicator"></div><div class="sc-actions"><button class="sc-action-btn edit-btn" title="ç·¨é›†">âœ</button><button class="sc-action-btn delete delete-btn" title="å‰Šé™¤">âœ•</button></div><div class="sc-content"><div class="sc-icon" style="background:${iconBg}">${s.icon}</div><div class="sc-name" style="font-size:${fs}px;text-shadow:${txtShadow}">${esc(s.name)}</div><div class="sc-category" style="text-shadow:${txtShadow}">${esc(s.category)}</div></div>`;
    el.querySelector('.drag-zone').addEventListener('mousedown',e=>{if(e.button===2)return;startDrag(el,e.clientX,e.clientY,'shortcut');e.preventDefault();});
    el.querySelector('.drag-zone').addEventListener('touchstart',e=>{const t=e.touches[0],rect=el.getBoundingClientRect(),rx=(t.clientX-rect.left)/rect.width,ry=(t.clientY-rect.top)/rect.height;if(rx>.2&&rx<.8&&ry>.2&&ry<.8)return;startDrag(el,t.clientX,t.clientY,'shortcut');e.preventDefault();},{passive:false});
    el.querySelector('.link-zone').addEventListener('click',e=>{e.stopPropagation();window.open(s.url,'_blank');});
    el.querySelector('.link-zone').addEventListener('touchend',e=>{if(!isDragging){e.preventDefault();window.open(s.url,'_blank');}});
    el.querySelector('.edit-btn').addEventListener('click',e=>{e.stopPropagation();editShortcut(s.id);});
    el.querySelector('.delete-btn').addEventListener('click',e=>{e.stopPropagation();deleteShortcut(s.id);});
    el.addEventListener('contextmenu',e=>{e.preventDefault();e.stopPropagation();ctxTargetId=s.id;showCtx(e.clientX,e.clientY);});
    cv.appendChild(el);
  });
}
function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML;}
function isLight(hex){const c=hex.replace('#','');const r=parseInt(c.substr(0,2),16),g=parseInt(c.substr(2,2),16),b=parseInt(c.substr(4,2),16);return(r*299+g*587+b*114)/1000>160;}
function updateCount(){document.getElementById('countInfo').textContent=state.shortcuts.length+' å€‹';buildCatTabs();}

// â”€â”€ Drag â”€â”€
function startDrag(el,cx,cy,type){isDragging=true;dragEl=el;dragType=type;dragId=parseInt(type==='frame'?el.dataset.fid:el.dataset.id);const r=el.getBoundingClientRect();dragOffsetX=cx-r.left;dragOffsetY=cy-r.top;el.classList.add('dragging');}
function onMM(e){if(isResizing)return doResize(e.clientX,e.clientY);if(!isDragging||!dragEl)return;const cv=document.getElementById('canvas'),cr=cv.getBoundingClientRect();dragEl.style.left=Math.max(0,e.clientX-cr.left-dragOffsetX+cv.scrollLeft)+'px';dragEl.style.top=Math.max(0,e.clientY-cr.top-dragOffsetY+cv.scrollTop)+'px';}
function onMU(){if(isResizing)return endResize();if(!isDragging||!dragEl)return;isDragging=false;dragEl.classList.remove('dragging');if(dragType==='shortcut'){const s=state.shortcuts.find(s=>s.id===dragId);if(s){s.x=parseInt(dragEl.style.left);s.y=parseInt(dragEl.style.top);saveToStorage();}}else if(dragType==='frame'){const f=(state.frames||[]).find(f=>f.id===dragId);if(f){f.x=parseInt(dragEl.style.left);f.y=parseInt(dragEl.style.top);saveToStorage();}}dragEl=null;}
function onTM(e){if(isResizing){e.preventDefault();return doResize(e.touches[0].clientX,e.touches[0].clientY);}if(!isDragging||!dragEl)return;e.preventDefault();const t=e.touches[0],cv=document.getElementById('canvas'),cr=cv.getBoundingClientRect();dragEl.style.left=Math.max(0,t.clientX-cr.left-dragOffsetX+cv.scrollLeft)+'px';dragEl.style.top=Math.max(0,t.clientY-cr.top-dragOffsetY+cv.scrollTop)+'px';}
function onTE(){if(isResizing)return endResize();if(!isDragging||!dragEl)return;isDragging=false;dragEl.classList.remove('dragging');if(dragType==='shortcut'){const s=state.shortcuts.find(s=>s.id===dragId);if(s){s.x=parseInt(dragEl.style.left);s.y=parseInt(dragEl.style.top);saveToStorage();}}else if(dragType==='frame'){const f=(state.frames||[]).find(f=>f.id===dragId);if(f){f.x=parseInt(dragEl.style.left);f.y=parseInt(dragEl.style.top);saveToStorage();}}dragEl=null;}

// â”€â”€ Frame Resize â”€â”€
function startResize(el,fid,cx,cy){isResizing=true;resizeEl=el;resizeId=fid;resizeStartX=cx;resizeStartY=cy;resizeStartW=el.offsetWidth;resizeStartH=el.offsetHeight;}
function doResize(cx,cy){if(!resizeEl)return;resizeEl.style.width=Math.max(100,resizeStartW+(cx-resizeStartX))+'px';resizeEl.style.height=Math.max(80,resizeStartH+(cy-resizeStartY))+'px';}
function endResize(){if(!resizeEl)return;isResizing=false;const f=(state.frames||[]).find(f=>f.id===resizeId);if(f){f.w=parseInt(resizeEl.style.width);f.h=parseInt(resizeEl.style.height);saveToStorage();}resizeEl=null;}

// â”€â”€ Frame CRUD â”€â”€
function openFrameModal(){frameEditId=null;frameSelectedColor=FRAME_COLORS[0];frameBorderWidth=3;document.getElementById('frameModalTitle').textContent='ã‚°ãƒ«ãƒ¼ãƒ—æ ã‚’è¿½åŠ ';document.getElementById('frameName').value='';document.getElementById('frameBorderSlider').value=3;document.getElementById('frameBorderLabel').textContent='3';document.getElementById('frameSubmitBtn').textContent='è¿½åŠ ';renderFrameColorPicker();document.getElementById('frameModal').classList.add('show');}
function editFrame(id){const f=(state.frames||[]).find(x=>x.id===id);if(!f)return;frameEditId=id;frameSelectedColor=f.color||FRAME_COLORS[0];frameBorderWidth=f.borderWidth||3;document.getElementById('frameModalTitle').textContent='ã‚°ãƒ«ãƒ¼ãƒ—æ ã‚’ç·¨é›†';document.getElementById('frameName').value=f.name;document.getElementById('frameBorderSlider').value=frameBorderWidth;document.getElementById('frameBorderLabel').textContent=frameBorderWidth;document.getElementById('frameSubmitBtn').textContent='æ›´æ–°';renderFrameColorPicker();document.getElementById('frameModal').classList.add('show');}
function closeFrameModal(){document.getElementById('frameModal').classList.remove('show');}
function renderFrameColorPicker(){const el=document.getElementById('frameColorPicker');el.innerHTML='';FRAME_COLORS.forEach(c=>{const s=document.createElement('div');s.className='frame-color-opt'+(c===frameSelectedColor?' active':'');s.style.background=c;s.onclick=()=>{frameSelectedColor=c;renderFrameColorPicker();};el.appendChild(s);});}
function submitFrame(){
  const name=document.getElementById('frameName').value.trim();if(!name){toast('ã‚°ãƒ«ãƒ¼ãƒ—åã‚’å…¥åŠ›','error');return;}
  const bw=parseInt(document.getElementById('frameBorderSlider').value);
  if(!state.frames)state.frames=[];
  if(frameEditId!==null){const f=state.frames.find(x=>x.id===frameEditId);if(f){f.name=name;f.color=frameSelectedColor;f.borderWidth=bw;}}
  else{state.frames.push({id:state.nextFrameId++,name,color:frameSelectedColor,borderWidth:bw,x:40,y:40,w:400,h:300});}
  saveToStorage();renderCanvas();closeFrameModal();toast(frameEditId!==null?'æ ã‚’æ›´æ–°':'æ ã‚’è¿½åŠ ','success');
}
function deleteFrame(id){state.frames=state.frames.filter(f=>f.id!==id);saveToStorage();renderCanvas();toast('æ ã‚’å‰Šé™¤','success');}

// â”€â”€ Frame Context â”€â”€
function showFrameCtx(x,y){const m=document.getElementById('frameContextMenu');m.style.left=x+'px';m.style.top=y+'px';m.classList.add('show');}
function hideFrameContextMenu(){document.getElementById('frameContextMenu').classList.remove('show');}
function fctxEdit(){editFrame(fctxTargetId);hideFrameContextMenu();}
function fctxDelete(){deleteFrame(fctxTargetId);hideFrameContextMenu();}

// â”€â”€ Shortcut Context â”€â”€
function showCtx(x,y){const m=document.getElementById('contextMenu');m.style.left=x+'px';m.style.top=y+'px';m.classList.add('show');}
function hideContextMenu(){document.getElementById('contextMenu').classList.remove('show');}
function ctxOpen(){const s=state.shortcuts.find(x=>x.id===ctxTargetId);if(s)window.open(s.url,'_blank');hideContextMenu();}
function ctxEdit(){editShortcut(ctxTargetId);hideContextMenu();}
function ctxDuplicate(){const s=state.shortcuts.find(x=>x.id===ctxTargetId);if(!s)return;state.shortcuts.push({...s,id:state.nextId++,x:s.x+20,y:s.y+20});saveToStorage();renderCanvas();updateCount();hideContextMenu();toast('è¤‡è£½','success');}
function ctxDelete(){deleteShortcut(ctxTargetId);hideContextMenu();}

// â”€â”€ Edit Shortcut â”€â”€
function editShortcut(id){
  const s=state.shortcuts.find(x=>x.id===id);if(!s)return;editingId=id;populateCatSelect();
  document.getElementById('editCat').value=s.category;document.getElementById('editName').value=s.name;document.getElementById('editUrl').value=s.url;
  document.getElementById('editSizeSlider').value=s.w||120;document.getElementById('editSizeLabel').textContent=s.w||120;
  document.getElementById('editFontSlider').value=s.fontSize||14;document.getElementById('editFontLabel').textContent=s.fontSize||14;
  editColor=s.color;editIcon=s.icon;
  rCP('editColorPicker',editColor,c=>{editColor=c;rCP('editColorPicker',editColor,arguments.callee);});
  rIP('editIconPicker',editIcon,i=>{editIcon=i;rIP('editIconPicker',editIcon,arguments.callee);});
  document.getElementById('editModal').classList.add('show');
}
function saveEdit(){const s=state.shortcuts.find(x=>x.id===editingId);if(!s)return;s.category=document.getElementById('editCat').value;s.name=document.getElementById('editName').value.trim();s.url=document.getElementById('editUrl').value.trim();s.color=editColor;s.icon=editIcon;s.w=parseInt(document.getElementById('editSizeSlider').value);s.h=s.w;s.fontSize=parseInt(document.getElementById('editFontSlider').value);saveToStorage();renderCanvas();closeEditModal();toast('æ›´æ–°','success');}
function deleteEditing(){state.shortcuts=state.shortcuts.filter(s=>s.id!==editingId);saveToStorage();renderCanvas();updateCount();closeEditModal();toast('å‰Šé™¤','success');}
function deleteShortcut(id){state.shortcuts=state.shortcuts.filter(s=>s.id!==id);saveToStorage();renderCanvas();updateCount();toast('å‰Šé™¤','success');}
function closeEditModal(){document.getElementById('editModal').classList.remove('show');}

// â”€â”€ Category â”€â”€
function manageCats(){renderCatList();document.getElementById('catModal').classList.add('show');}
function closeCatModal(){document.getElementById('catModal').classList.remove('show');populateCatSelect();}
function renderCatList(){const el=document.getElementById('catList');el.innerHTML='';state.categories.forEach((c,i)=>{const r=document.createElement('div');r.className='cat-manage-row';r.innerHTML=`<span>${esc(c)}</span><button class="btn btn-sm btn-danger" onclick="removeCat(${i})">å‰Šé™¤</button>`;el.appendChild(r);});}
function addCategory(){const inp=document.getElementById('newCatInput'),nm=inp.value.trim();if(!nm)return;if(state.categories.includes(nm)){toast('æ—¢ã«å­˜åœ¨','error');return;}state.categories.push(nm);saveToStorage();renderCatList();inp.value='';toast('è¿½åŠ ','success');}
function removeCat(i){if(state.shortcuts.some(s=>s.category===state.categories[i])){toast('ä½¿ç”¨ä¸­ã¯å‰Šé™¤ä¸å¯','error');return;}state.categories.splice(i,1);saveToStorage();renderCatList();}

// â”€â”€ Export/Import â”€â”€
function exportJSON(){const b=new Blob([JSON.stringify(state,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='shortcuts.json';a.click();toast('JSONãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†','success');}
function importData(){document.getElementById('importText').value='';document.getElementById('importFile').value='';document.getElementById('importModal').classList.add('show');}
function closeImportModal(){document.getElementById('importModal').classList.remove('show');}
function doImport(){const f=document.getElementById('importFile').files[0],t=document.getElementById('importText').value.trim();if(f){const r=new FileReader();r.onload=e=>{try{applyImport(JSON.parse(e.target.result));}catch(err){toast('JSONè§£æã‚¨ãƒ©ãƒ¼','error');}};r.readAsText(f);}else if(t){try{applyImport(JSON.parse(t));}catch(err){toast('JSONè§£æã‚¨ãƒ©ãƒ¼','error');}}else toast('å…¥åŠ›ã—ã¦ãã ã•ã„','error');}
function applyImport(d){if(d.categories)state.categories=[...new Set([...state.categories,...d.categories])];if(d.shortcuts){const mx=state.shortcuts.reduce((m,s)=>Math.max(m,s.id),0);d.shortcuts.forEach((s,i)=>{s.id=mx+i+1;state.shortcuts.push(s);});state.nextId=state.shortcuts.reduce((m,s)=>Math.max(m,s.id),0)+1;}if(d.frames){const mf=(state.frames||[]).reduce((m,f)=>Math.max(m,f.id),0);d.frames.forEach((f,i)=>{f.id=mf+i+1;state.frames.push(f);});state.nextFrameId=(state.frames||[]).reduce((m,f)=>Math.max(m,f.id),0)+1;}saveToStorage();populateCatSelect();renderCanvas();updateCount();closeImportModal();toast('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†','success');}

function switchTab(tab){
  document.querySelectorAll('.sidebar-tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('tabShortcut').style.display=tab==='shortcut'?'':'none';
  document.getElementById('tabSettings').style.display=tab==='settings'?'':'none';
  document.querySelectorAll('.sidebar-tab').forEach(t=>{if(t.textContent.includes(tab==='shortcut'?'ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ':'è¨­å®š'))t.classList.add('active');});
}

function toggleSidebar(forceOpen){
  const sb=document.querySelector('.sidebar'),arrow=document.querySelector('.sidebar-toggle .arrow');
  if(forceOpen===true){sb.classList.remove('hidden');arrow.textContent='â—€';}
  else{sb.classList.toggle('hidden');arrow.textContent=sb.classList.contains('hidden')?'â–¶':'â—€';}
}

function toast(msg,type='success'){const c=document.getElementById('toastContainer'),t=document.createElement('div');t.className='toast '+type;t.textContent=msg;c.appendChild(t);setTimeout(()=>t.remove(),3000);}

init();
</script>
</body>
</html>
