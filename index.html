<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Shortcut Builder</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ”—</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#0f1117; --surface:#1a1d27; --surface2:#232733; --border:#2e3345;
  --text:#e4e6f0; --text2:#8b8fa7; --accent:#4f8cff; --accent2:#6c5ce7;
  --danger:#ff6b6b; --success:#51cf66; --radius:10px;
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Noto Sans JP',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow:hidden}

.header{background:linear-gradient(135deg,#1a1d27,#232733);border-bottom:1px solid var(--border);padding:12px 20px;display:flex;align-items:center;justify-content:space-between;z-index:100;height:52px}
.header h1{font-size:16px;font-weight:700;display:flex;align-items:center;gap:10px}
.header h1::before{content:'';width:24px;height:24px;background:linear-gradient(135deg,var(--accent),var(--accent2));border-radius:6px;display:inline-block}
.header-actions{display:flex;gap:6px;flex-wrap:wrap;align-items:center}

.btn{font-family:inherit;font-size:12px;font-weight:500;padding:6px 14px;border:1px solid var(--border);border-radius:7px;background:var(--surface2);color:var(--text);cursor:pointer;transition:all .15s;display:inline-flex;align-items:center;gap:5px;white-space:nowrap}
.btn:hover{background:var(--border)}
.btn-primary{background:var(--accent);border-color:var(--accent);color:#fff}
.btn-primary:hover{background:#3d7aee}
.btn-save{background:#7c3aed;border-color:#7c3aed;color:#fff}
.btn-save:hover{background:#6d28d9}
.btn-load{background:#059669;border-color:#059669;color:#fff}
.btn-load:hover{background:#047857}
.btn-danger{border-color:var(--danger);color:var(--danger)}
.btn-danger:hover{background:rgba(255,107,107,.1)}
.btn-sm{padding:4px 8px;font-size:11px}
.btn:disabled{opacity:.5;cursor:not-allowed}

.pin-display{font-family:'JetBrains Mono',monospace;font-size:13px;padding:5px 12px;background:var(--bg);border:1px solid var(--border);border-radius:7px;color:var(--accent);letter-spacing:3px;font-weight:600}

.app{display:flex;height:calc(100vh - 52px)}
.sidebar{width:300px;min-width:300px;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow-y:auto;z-index:50}
.sidebar-section{padding:16px;border-bottom:1px solid var(--border)}
.sidebar-section h3{font-size:11px;font-weight:500;color:var(--text2);text-transform:uppercase;letter-spacing:1px;margin-bottom:12px}

.form-group{margin-bottom:12px}
.form-group label{display:block;font-size:11px;font-weight:500;color:var(--text2);margin-bottom:5px}
.form-group input,.form-group select{width:100%;font-family:inherit;font-size:13px;padding:8px 10px;background:var(--bg);border:1px solid var(--border);border-radius:7px;color:var(--text);outline:none;transition:border-color .15s}
.form-group input:focus,.form-group select:focus{border-color:var(--accent)}
.form-group input::placeholder{color:var(--text2);opacity:.5}

.color-row{display:flex;gap:5px;flex-wrap:wrap}
.color-swatch{width:26px;height:26px;border-radius:6px;border:2px solid transparent;cursor:pointer;transition:all .15s}
.color-swatch:hover{transform:scale(1.15)}
.color-swatch.active{border-color:#fff;box-shadow:0 0 0 2px var(--accent)}

.icon-row{display:flex;gap:5px;flex-wrap:wrap}
.icon-option{width:32px;height:32px;display:flex;align-items:center;justify-content:center;background:var(--bg);border:1px solid var(--border);border-radius:6px;cursor:pointer;font-size:15px;transition:all .15s}
.icon-option:hover{border-color:var(--accent)}
.icon-option.active{border-color:var(--accent);background:rgba(79,140,255,.15)}

.preview-area{padding:16px;display:flex;flex-direction:column;align-items:center;gap:8px}
.preview-label{font-size:10px;color:var(--text2);text-transform:uppercase;letter-spacing:1px}

.size-slider{width:100%;-webkit-appearance:none;height:4px;border-radius:2px;background:var(--border);outline:none}
.size-slider::-webkit-slider-thumb{-webkit-appearance:none;width:16px;height:16px;border-radius:50%;background:var(--accent);cursor:pointer}

.canvas-wrapper{flex:1;position:relative;overflow:hidden;background:radial-gradient(circle at 50% 50%,rgba(79,140,255,.02) 0%,transparent 70%),var(--bg)}
.canvas{position:absolute;inset:0;overflow:auto}
.canvas::before{content:'';position:absolute;inset:0;width:5000px;height:5000px;background-image:radial-gradient(circle,var(--border) 1px,transparent 1px);background-size:40px 40px;pointer-events:none;opacity:.35}

.shortcut-btn{position:absolute;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;border-radius:var(--radius);border:1px solid rgba(255,255,255,.08);text-decoration:none;color:var(--text);user-select:none;z-index:10;overflow:hidden;transition:box-shadow .2s,transform .2s}
.shortcut-btn:hover{box-shadow:0 8px 28px rgba(0,0,0,.5);z-index:20}
.shortcut-btn.dragging{box-shadow:0 16px 48px rgba(0,0,0,.6);z-index:1000;transition:none;transform:scale(1.05)}

.shortcut-btn .link-zone{position:absolute;top:20%;left:20%;right:20%;bottom:20%;cursor:pointer;z-index:5;border-radius:6px;transition:background .15s}
.shortcut-btn .link-zone:hover{background:rgba(255,255,255,.08)}
.shortcut-btn .drag-zone{position:absolute;inset:0;cursor:grab;z-index:3}
.shortcut-btn.dragging .drag-zone{cursor:grabbing}
.shortcut-btn .drag-edge-indicator{position:absolute;inset:0;border:2px dashed transparent;border-radius:var(--radius);pointer-events:none;transition:border-color .2s;z-index:6}
.shortcut-btn:hover .drag-edge-indicator{border-color:rgba(255,255,255,.12)}

.shortcut-btn .sc-content{position:relative;z-index:4;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;pointer-events:none;width:100%;height:100%;padding:14px 10px}
.shortcut-btn .sc-icon{font-size:22px;width:40px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:9px;background:rgba(255,255,255,.15)}
.shortcut-btn .sc-name{font-size:11px;font-weight:600;text-align:center;line-height:1.3;word-break:break-word;max-width:100%;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;text-shadow:0 1px 3px rgba(0,0,0,.4)}
.shortcut-btn .sc-category{font-size:8px;text-transform:uppercase;letter-spacing:.5px;opacity:.7}

.shortcut-btn .sc-actions{position:absolute;top:3px;right:3px;display:none;gap:2px;z-index:8}
.shortcut-btn:hover .sc-actions{display:flex}
.sc-action-btn{width:20px;height:20px;border:none;border-radius:4px;background:rgba(0,0,0,.5);color:rgba(255,255,255,.7);font-size:10px;cursor:pointer;display:flex;align-items:center;justify-content:center;pointer-events:auto}
.sc-action-btn:hover{color:#fff;background:rgba(0,0,0,.7)}
.sc-action-btn.delete:hover{color:var(--danger)}

.context-menu{display:none;position:fixed;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:4px;z-index:500;min-width:160px;box-shadow:0 12px 36px rgba(0,0,0,.5)}
.context-menu.show{display:block}
.context-menu-item{font-family:inherit;font-size:12px;padding:8px 12px;border:none;background:none;color:var(--text);cursor:pointer;width:100%;text-align:left;border-radius:5px;display:block}
.context-menu-item:hover{background:var(--border)}
.context-menu-item.danger{color:var(--danger)}

.canvas-info{position:absolute;bottom:12px;left:50%;transform:translateX(-50%);background:var(--surface2);border:1px solid var(--border);border-radius:20px;padding:6px 16px;font-size:11px;color:var(--text2);z-index:30;display:flex;gap:16px;align-items:center;pointer-events:none}

.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(4px);z-index:200;align-items:center;justify-content:center}
.modal-overlay.show{display:flex}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:14px;width:480px;max-width:90vw;max-height:80vh;overflow-y:auto;padding:24px}
.modal h2{font-size:15px;font-weight:700;margin-bottom:16px}
.modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:18px}

.pin-input-group{display:flex;gap:8px;justify-content:center;margin:16px 0}
.pin-digit{width:52px;height:60px;font-family:'JetBrains Mono',monospace;font-size:28px;font-weight:700;text-align:center;background:var(--bg);border:2px solid var(--border);border-radius:10px;color:var(--accent);outline:none;transition:border-color .2s}
.pin-digit:focus{border-color:var(--accent)}
.pin-status{text-align:center;font-size:12px;margin-top:8px;min-height:18px}
.pin-status.success{color:var(--success)}
.pin-status.error{color:var(--danger)}
.pin-status.loading{color:var(--accent)}

.toast-container{position:fixed;bottom:20px;right:20px;z-index:300;display:flex;flex-direction:column;gap:6px}
.toast{padding:10px 16px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;font-size:12px;animation:slideIn .3s ease;box-shadow:0 8px 24px rgba(0,0,0,.3)}
.toast.success{border-left:3px solid var(--success)}
.toast.error{border-left:3px solid var(--danger)}
@keyframes slideIn{from{transform:translateX(80px);opacity:0}to{transform:translateX(0);opacity:1}}

.cat-manage-row{display:flex;align-items:center;gap:8px;margin-bottom:6px;padding:6px 8px;background:var(--bg);border-radius:6px}
.cat-manage-row span{flex:1;font-size:13px}

.empty-hint{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;color:var(--text2);pointer-events:none;z-index:5}
.empty-hint .icon{font-size:48px;opacity:.2;margin-bottom:12px}
.empty-hint p{font-size:13px;opacity:.6;line-height:1.8}

/* Settings gear */
.settings-btn{background:none;border:none;color:var(--text2);font-size:18px;cursor:pointer;padding:4px;transition:color .15s;line-height:1}
.settings-btn:hover{color:var(--text)}

@media(max-width:768px){
  .app{flex-direction:column}
  .sidebar{width:100%;min-width:unset;max-height:45vh;border-right:none;border-bottom:1px solid var(--border)}
  .canvas-wrapper{min-height:55vh}
  .header-actions{gap:4px}
  .btn{font-size:11px;padding:5px 10px}
}
</style>
</head>
<body>

<!-- =====================================================
  CONFIGURATION: Set your GAS Web App URL below
  ===================================================== -->

<div class="header">
  <h1>Shortcut Builder</h1>
  <div class="header-actions">
    <button class="btn" onclick="manageCats()">ã‚«ãƒ†ã‚´ãƒªãƒ¼ç®¡ç†</button>
    <button class="btn" onclick="importData()">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
    <button class="btn" onclick="exportJSON()">JSONä¿å­˜</button>
    <span style="width:1px;height:24px;background:var(--border);margin:0 4px"></span>
    <button class="btn btn-save" onclick="openSaveModal()">æ–°è¦ä¿å­˜</button>
    <button class="btn btn-save" onclick="doCloudUpdate()" id="updateBtn" style="display:none;background:#6d28d9;border-color:#6d28d9;">ä¸Šæ›¸ãæ›´æ–°</button>
    <button class="btn btn-load" onclick="openLoadModal()">ã‚¯ãƒ©ã‚¦ãƒ‰èª­è¾¼</button>
    <span id="currentPin" class="pin-display" style="display:none"></span>
    <button class="settings-btn" onclick="openSettingsModal()" title="è¨­å®š">âš™</button>
  </div>
</div>

<div class="app">
  <div class="sidebar">
    <div class="sidebar-section">
      <h3>ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆè¿½åŠ </h3>
      <div class="form-group"><label>ã‚«ãƒ†ã‚´ãƒªãƒ¼</label><select id="catSelect"></select></div>
      <div class="form-group"><label>ä½œæ¥­å</label><input type="text" id="scName" placeholder="ä¾‹: å‹¤æ€ ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ "></div>
      <div class="form-group"><label>URL</label><input type="text" id="scUrl" placeholder="https://..."></div>
    </div>
    <div class="sidebar-section">
      <h3>ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º</h3>
      <div class="form-group"><label>ãƒœã‚¿ãƒ³ã‚«ãƒ©ãƒ¼</label><div class="color-row" id="colorPicker"></div></div>
      <div class="form-group"><label>ã‚¢ã‚¤ã‚³ãƒ³</label><div class="icon-row" id="iconPicker"></div></div>
      <div class="form-group"><label>ãƒœã‚¿ãƒ³ã‚µã‚¤ã‚º: <span id="sizeLabel">120</span>px</label><input type="range" class="size-slider" id="sizeSlider" min="80" max="200" value="120"></div>
    </div>
    <div class="sidebar-section">
      <div class="preview-area">
        <span class="preview-label">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</span>
        <div id="previewBtn" style="position:relative;width:120px;height:120px;border-radius:10px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;border:1px solid rgba(255,255,255,.08);overflow:hidden;">
          <div class="sc-icon" id="previewIcon" style="font-size:22px;width:40px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:9px;background:rgba(255,255,255,.15);">ğŸ”—</div>
          <div id="previewName" style="font-size:11px;font-weight:600;text-align:center;text-shadow:0 1px 3px rgba(0,0,0,.4);">ä½œæ¥­å</div>
        </div>
      </div>
      <button class="btn btn-primary" style="width:100%;justify-content:center;" onclick="addShortcut()">è¿½åŠ ã™ã‚‹</button>
    </div>
  </div>
  <div class="canvas-wrapper">
    <div class="canvas" id="canvas"></div>
    <div class="canvas-info"><span id="countInfo">0 å€‹</span><span>ç«¯ãƒ‰ãƒ©ãƒƒã‚°=ç§»å‹•</span><span>ä¸­å¤®ã‚¯ãƒªãƒƒã‚¯=ãƒªãƒ³ã‚¯</span><span>å³ã‚¯ãƒªãƒƒã‚¯=ãƒ¡ãƒ‹ãƒ¥ãƒ¼</span></div>
  </div>
</div>

<div class="context-menu" id="contextMenu">
  <button class="context-menu-item" onclick="ctxOpen()">é–‹ã</button>
  <button class="context-menu-item" onclick="ctxEdit()">ç·¨é›†</button>
  <button class="context-menu-item" onclick="ctxDuplicate()">è¤‡è£½</button>
  <button class="context-menu-item danger" onclick="ctxDelete()">å‰Šé™¤</button>
</div>

<!-- Category Modal -->
<div class="modal-overlay" id="catModal"><div class="modal">
  <h2>ã‚«ãƒ†ã‚´ãƒªãƒ¼ç®¡ç†</h2>
  <div id="catList"></div>
  <div style="display:flex;gap:8px;margin-top:12px;">
    <input type="text" id="newCatInput" placeholder="æ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªãƒ¼å" style="flex:1;font-family:inherit;font-size:13px;padding:8px 10px;background:var(--bg);border:1px solid var(--border);border-radius:7px;color:var(--text);outline:none;">
    <button class="btn btn-primary" onclick="addCategory()">è¿½åŠ </button>
  </div>
  <div class="modal-actions"><button class="btn" onclick="closeCatModal()">é–‰ã˜ã‚‹</button></div>
</div></div>

<!-- Edit Modal -->
<div class="modal-overlay" id="editModal"><div class="modal">
  <h2>ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆç·¨é›†</h2>
  <div class="form-group"><label>ã‚«ãƒ†ã‚´ãƒªãƒ¼</label><select id="editCat"></select></div>
  <div class="form-group"><label>ä½œæ¥­å</label><input type="text" id="editName"></div>
  <div class="form-group"><label>URL</label><input type="text" id="editUrl"></div>
  <div class="form-group"><label>ã‚«ãƒ©ãƒ¼</label><div class="color-row" id="editColorPicker"></div></div>
  <div class="form-group"><label>ã‚¢ã‚¤ã‚³ãƒ³</label><div class="icon-row" id="editIconPicker"></div></div>
  <div class="form-group"><label>ã‚µã‚¤ã‚º: <span id="editSizeLabel">120</span>px</label><input type="range" class="size-slider" id="editSizeSlider" min="80" max="200" value="120"></div>
  <div class="modal-actions">
    <button class="btn btn-danger" onclick="deleteEditing()">å‰Šé™¤</button>
    <button class="btn" onclick="closeEditModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    <button class="btn btn-primary" onclick="saveEdit()">ä¿å­˜</button>
  </div>
</div></div>

<!-- Settings Modal -->
<div class="modal-overlay" id="settingsModal"><div class="modal">
  <h2>è¨­å®š</h2>
  <div class="form-group">
    <label>GAS API URL</label>
    <input type="text" id="gasUrlInput" placeholder="https://script.google.com/macros/s/XXXX/exec">
  </div>
  <p style="font-size:11px;color:var(--text2);margin-top:4px;line-height:1.6;">
    Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ + Apps Script ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã®URLã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚<br>
    è¨­å®šã¯ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚
  </p>
  <div class="modal-actions">
    <button class="btn" onclick="closeSettingsModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    <button class="btn btn-primary" onclick="saveGasUrl()">ä¿å­˜</button>
  </div>
</div></div>

<!-- Save Modal -->
<div class="modal-overlay" id="saveModal"><div class="modal" style="text-align:center;">
  <h2 id="saveModalTitle">ãƒã‚¤ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’ä¿å­˜</h2>
  <p id="saveModalDesc" style="font-size:12px;color:var(--text2);margin-bottom:8px;">4æ¡ã®PINã‚³ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚<br>ã“ã®PINã§ä»–ã®PCã‹ã‚‰ã‚‚å‘¼ã³å‡ºã›ã¾ã™ã€‚</p>
  <div class="pin-input-group" id="savePinGroup">
    <input type="text" class="pin-digit" maxlength="1" inputmode="numeric">
    <input type="text" class="pin-digit" maxlength="1" inputmode="numeric">
    <input type="text" class="pin-digit" maxlength="1" inputmode="numeric">
    <input type="text" class="pin-digit" maxlength="1" inputmode="numeric">
  </div>
  <div class="pin-status" id="saveStatus"></div>
  <div class="modal-actions" style="justify-content:center;">
    <button class="btn" onclick="closeSaveModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    <button class="btn btn-save" id="saveBtn" onclick="doCloudSave()">æ–°è¦ä¿å­˜</button>
  </div>
</div></div>

<!-- Load Modal -->
<div class="modal-overlay" id="loadModal"><div class="modal" style="text-align:center;">
  <h2>ãƒã‚¤ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’èª­ã¿è¾¼ã¿</h2>
  <p style="font-size:12px;color:var(--text2);margin-bottom:8px;">ä¿å­˜æ™‚ã«è¨­å®šã—ãŸ4æ¡PINã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
  <div class="pin-input-group" id="loadPinGroup">
    <input type="text" class="pin-digit" maxlength="1" inputmode="numeric">
    <input type="text" class="pin-digit" maxlength="1" inputmode="numeric">
    <input type="text" class="pin-digit" maxlength="1" inputmode="numeric">
    <input type="text" class="pin-digit" maxlength="1" inputmode="numeric">
  </div>
  <div class="pin-status" id="loadStatus"></div>
  <div class="modal-actions" style="justify-content:center;">
    <button class="btn" onclick="closeLoadModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    <button class="btn btn-load" id="loadBtn" onclick="doCloudLoad()">èª­ã¿è¾¼ã‚€</button>
  </div>
</div></div>

<!-- Import Modal -->
<div class="modal-overlay" id="importModal"><div class="modal">
  <h2>ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h2>
  <p style="font-size:12px;color:var(--text2);margin-bottom:12px;">JSONãƒ•ã‚¡ã‚¤ãƒ«ã¾ãŸã¯ãƒ†ã‚­ã‚¹ãƒˆã‚’è²¼ã‚Šä»˜ã‘</p>
  <input type="file" id="importFile" accept=".json" style="margin-bottom:10px;font-size:12px;color:var(--text);">
  <textarea id="importText" rows="6" placeholder="JSONãƒ†ã‚­ã‚¹ãƒˆ..." style="width:100%;font-family:'JetBrains Mono',monospace;font-size:11px;padding:10px;background:var(--bg);border:1px solid var(--border);border-radius:7px;color:var(--text);outline:none;resize:vertical;"></textarea>
  <div class="modal-actions">
    <button class="btn" onclick="closeImportModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    <button class="btn btn-primary" onclick="doImport()">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
  </div>
</div></div>

<div class="toast-container" id="toastContainer"></div>

<script>
// ================================================================
// CONFIG: Set your GAS Web App URL here for default
// ================================================================
const DEFAULT_GAS_URL = 'https://script.google.com/macros/s/AKfycbwawYZmDBj2GtwF7huYO8LLQG4IqUnotxs1M6A6Lk9F-PDnMF8KsYqIfeju4zJUHr0L/exec';
// ================================================================

const COLORS=['#60A5FA','#38BDF8','#22D3EE','#67E8F9','#4ADE80','#34D399','#2DD4BF','#A3E635','#FACC15','#FDE047','#FB923C','#FDBA74','#F87171','#FB7185','#F472B6','#FF6B9D','#A78BFA','#C084FC','#E879F9','#818CF8','#93C5FD','#86EFAC','#FCA5A1','#FDE68A','#D8B4FE','#A5F3FC','#FBCFE8','#BAE6FD','#FF8A80','#FFB74D'];
const ICONS=['ğŸ”—','ğŸ“Š','ğŸ“‹','ğŸ“','ğŸ“§','ğŸ’¼','ğŸ”§','ğŸ“±','ğŸ–¥ï¸','ğŸ“','ğŸ“…','ğŸ‘¥','ğŸ“¦','ğŸ”','âš™ï¸','ğŸ ','ğŸ“ˆ','ğŸ’°','ğŸ›’','â˜ï¸','ğŸ”’','ğŸ“','ğŸ¯','âœ…','â­','ğŸš€','ğŸ’¡','ğŸ“–','ğŸ—‚ï¸','ğŸŒ'];

let state={categories:['æ¥­å‹™ã‚·ã‚¹ãƒ†ãƒ ','ç®¡ç†ãƒ„ãƒ¼ãƒ«','å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹'],shortcuts:[],nextId:1};
let selectedColor=COLORS[0],selectedIcon=ICONS[0],editColor=COLORS[0],editIcon=ICONS[0];
let editingId=null,ctxTargetId=null;
let isDragging=false,dragEl=null,dragId=null,dragOffsetX=0,dragOffsetY=0;
let currentPin=null;
let GAS_URL='';

function init(){
  loadGasUrl();
  loadFromStorage();
  buildPickers();
  populateCatSelect();
  renderCanvas();
  updatePreview();
  updateCount();
  setupPinInputs('savePinGroup');
  setupPinInputs('loadPinGroup');

  document.getElementById('scName').addEventListener('input',updatePreview);
  document.getElementById('sizeSlider').addEventListener('input',e=>{document.getElementById('sizeLabel').textContent=e.target.value;updatePreview();});
  document.getElementById('editSizeSlider').addEventListener('input',e=>{document.getElementById('editSizeLabel').textContent=e.target.value;});
  document.addEventListener('click',()=>hideContextMenu());
  document.addEventListener('mousemove',onMM);
  document.addEventListener('mouseup',onMU);
  document.addEventListener('touchmove',onTM,{passive:false});
  document.addEventListener('touchend',onTE);

  // If no GAS URL configured, prompt settings
  if(!GAS_URL){
    setTimeout(()=>{ toast('å³ä¸Šã® âš™ ã‹ã‚‰GAS API URLã‚’è¨­å®šã—ã¦ãã ã•ã„','error'); },500);
  }
}

// â”€â”€ GAS URL â”€â”€
function loadGasUrl(){
  GAS_URL = localStorage.getItem('sb_gas_url') || DEFAULT_GAS_URL;
  document.getElementById('gasUrlInput').value = GAS_URL;
}
function saveGasUrl(){
  GAS_URL = document.getElementById('gasUrlInput').value.trim();
  localStorage.setItem('sb_gas_url', GAS_URL);
  closeSettingsModal();
  toast(GAS_URL ? 'API URLã‚’ä¿å­˜ã—ã¾ã—ãŸ' : 'API URLã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'success');
}
function openSettingsModal(){
  document.getElementById('gasUrlInput').value = GAS_URL;
  document.getElementById('settingsModal').classList.add('show');
}
function closeSettingsModal(){ document.getElementById('settingsModal').classList.remove('show'); }

// â”€â”€ Storage â”€â”€
function saveToStorage(){try{localStorage.setItem('sb_v5',JSON.stringify(state));}catch(e){}}
function loadFromStorage(){try{const d=localStorage.getItem('sb_v5');if(d)state=JSON.parse(d);}catch(e){}}

// â”€â”€ PIN Input â”€â”€
function setupPinInputs(groupId){
  const inputs=document.getElementById(groupId).querySelectorAll('.pin-digit');
  inputs.forEach((inp,i)=>{
    inp.addEventListener('input',()=>{inp.value=inp.value.replace(/\D/g,'').slice(0,1);if(inp.value&&i<3)inputs[i+1].focus();});
    inp.addEventListener('keydown',e=>{if(e.key==='Backspace'&&!inp.value&&i>0){inputs[i-1].focus();inputs[i-1].value='';}});
    inp.addEventListener('paste',e=>{e.preventDefault();const p=(e.clipboardData||window.clipboardData).getData('text').replace(/\D/g,'').slice(0,4);p.split('').forEach((ch,j)=>{if(inputs[j])inputs[j].value=ch;});if(p.length>0)inputs[Math.min(p.length,3)].focus();});
  });
}
function getPinFromGroup(gid){return Array.from(document.getElementById(gid).querySelectorAll('.pin-digit')).map(i=>i.value).join('');}
function clearPinGroup(gid){document.getElementById(gid).querySelectorAll('.pin-digit').forEach(i=>i.value='');}

// â”€â”€ Cloud Save â”€â”€
function openSaveModal(){
  if(!GAS_URL){toast('å…ˆã« âš™ ã‹ã‚‰GAS API URLã‚’è¨­å®šã—ã¦ãã ã•ã„','error');return;}
  clearPinGroup('savePinGroup');document.getElementById('saveStatus').textContent='';
  document.getElementById('saveModal').classList.add('show');
  setTimeout(()=>document.getElementById('savePinGroup').querySelector('.pin-digit').focus(),100);
}
function closeSaveModal(){document.getElementById('saveModal').classList.remove('show');}

async function doCloudSave(){
  const pin=getPinFromGroup('savePinGroup');
  if(pin.length!==4){setStatus('saveStatus','4æ¡ã™ã¹ã¦å…¥åŠ›ã—ã¦ãã ã•ã„','error');return;}
  document.getElementById('saveBtn').disabled=true;
  setStatus('saveStatus','ä¿å­˜ä¸­...','loading');
  try{
    const res=await fetch(GAS_URL,{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify({action:'save',pin,data:state})});
    const json=await res.json();
    if(json.success){
      currentPin=pin;
      document.getElementById('currentPin').textContent='PIN: '+pin;
      document.getElementById('currentPin').style.display='inline-block';
      document.getElementById('updateBtn').style.display='inline-flex';
      setStatus('saveStatus',json.message,'success');
      toast('ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜ã—ã¾ã—ãŸ (PIN: '+pin+')','success');
      setTimeout(closeSaveModal,1200);
    }else{setStatus('saveStatus',json.error||'ä¿å­˜å¤±æ•—','error');}
  }catch(err){setStatus('saveStatus','é€šä¿¡ã‚¨ãƒ©ãƒ¼: '+err.message,'error');}
  document.getElementById('saveBtn').disabled=false;
}

// â”€â”€ Cloud Update (overwrite existing PIN) â”€â”€
async function doCloudUpdate(){
  if(!currentPin){toast('å…ˆã«ã‚¯ãƒ©ã‚¦ãƒ‰ä¿å­˜ã¾ãŸã¯èª­è¾¼ã‚’ã—ã¦ãã ã•ã„','error');return;}
  if(!GAS_URL){toast('å…ˆã« âš™ ã‹ã‚‰GAS API URLã‚’è¨­å®šã—ã¦ãã ã•ã„','error');return;}
  toast('ä¸Šæ›¸ãæ›´æ–°ä¸­...','success');
  try{
    const res=await fetch(GAS_URL,{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify({action:'update',pin:currentPin,data:state})});
    const json=await res.json();
    if(json.success){
      toast('PIN: '+currentPin+' ã‚’ä¸Šæ›¸ãæ›´æ–°ã—ã¾ã—ãŸ','success');
    }else{toast(json.error||'æ›´æ–°å¤±æ•—','error');}
  }catch(err){toast('é€šä¿¡ã‚¨ãƒ©ãƒ¼: '+err.message,'error');}
}

// â”€â”€ Cloud Load â”€â”€
function openLoadModal(){
  if(!GAS_URL){toast('å…ˆã« âš™ ã‹ã‚‰GAS API URLã‚’è¨­å®šã—ã¦ãã ã•ã„','error');return;}
  clearPinGroup('loadPinGroup');document.getElementById('loadStatus').textContent='';
  document.getElementById('loadModal').classList.add('show');
  setTimeout(()=>document.getElementById('loadPinGroup').querySelector('.pin-digit').focus(),100);
}
function closeLoadModal(){document.getElementById('loadModal').classList.remove('show');}

async function doCloudLoad(){
  const pin=getPinFromGroup('loadPinGroup');
  if(pin.length!==4){setStatus('loadStatus','4æ¡ã™ã¹ã¦å…¥åŠ›ã—ã¦ãã ã•ã„','error');return;}
  document.getElementById('loadBtn').disabled=true;
  setStatus('loadStatus','èª­ã¿è¾¼ã¿ä¸­...','loading');
  try{
    const res=await fetch(GAS_URL,{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify({action:'load',pin})});
    const json=await res.json();
    if(json.success){
      state=json.data;saveToStorage();populateCatSelect();renderCanvas();updateCount();
      currentPin=pin;
      document.getElementById('currentPin').textContent='PIN: '+pin;
      document.getElementById('currentPin').style.display='inline-block';
      document.getElementById('updateBtn').style.display='inline-flex';
      setStatus('loadStatus','èª­ã¿è¾¼ã¿å®Œäº†','success');
      toast('ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰èª­ã¿è¾¼ã¿ã¾ã—ãŸ (PIN: '+pin+')','success');
      setTimeout(closeLoadModal,1200);
    }else{setStatus('loadStatus',json.error||'èª­ã¿è¾¼ã¿å¤±æ•—','error');}
  }catch(err){setStatus('loadStatus','é€šä¿¡ã‚¨ãƒ©ãƒ¼: '+err.message,'error');}
  document.getElementById('loadBtn').disabled=false;
}

function setStatus(id,msg,type){const el=document.getElementById(id);el.textContent=msg;el.className='pin-status '+type;}

// â”€â”€ Pickers â”€â”€
function buildPickers(){
  rCP('colorPicker',selectedColor,c=>{selectedColor=c;buildPickers();updatePreview();});
  rIP('iconPicker',selectedIcon,i=>{selectedIcon=i;buildPickers();updatePreview();});
}
function rCP(id,act,cb){const el=document.getElementById(id);el.innerHTML='';COLORS.forEach(c=>{const s=document.createElement('div');s.className='color-swatch'+(c===act?' active':'');s.style.background=c;s.onclick=()=>cb(c);el.appendChild(s);});}
function rIP(id,act,cb){const el=document.getElementById(id);el.innerHTML='';ICONS.forEach(ic=>{const s=document.createElement('div');s.className='icon-option'+(ic===act?' active':'');s.textContent=ic;s.onclick=()=>cb(ic);el.appendChild(s);});}
function populateCatSelect(){['catSelect','editCat'].forEach(id=>{const s=document.getElementById(id);if(!s)return;s.innerHTML='';state.categories.forEach(c=>{const o=document.createElement('option');o.value=c;o.textContent=c;s.appendChild(o);});});}

// â”€â”€ Preview â”€â”€
function updatePreview(){
  const nm=document.getElementById('scName').value||'ä½œæ¥­å',sz=parseInt(document.getElementById('sizeSlider').value);
  const p=document.getElementById('previewBtn');
  p.style.width=sz+'px';p.style.height=sz+'px';
  p.style.background=`linear-gradient(145deg,${selectedColor}DD,${selectedColor}88)`;
  document.getElementById('previewName').textContent=nm;
  document.getElementById('previewIcon').textContent=selectedIcon;
}

// â”€â”€ Add â”€â”€
function addShortcut(){
  const cat=document.getElementById('catSelect').value,name=document.getElementById('scName').value.trim(),url=document.getElementById('scUrl').value.trim(),size=parseInt(document.getElementById('sizeSlider').value);
  if(!name){toast('ä½œæ¥­åã‚’å…¥åŠ›','error');return;}
  if(!url){toast('URLã‚’å…¥åŠ›','error');return;}
  const pos=findFree(size);
  state.shortcuts.push({id:state.nextId++,category:cat,name,url,color:selectedColor,icon:selectedIcon,x:pos.x,y:pos.y,w:size,h:size});
  saveToStorage();renderCanvas();updateCount();
  document.getElementById('scName').value='';document.getElementById('scUrl').value='';
  updatePreview();toast('è¿½åŠ ã—ã¾ã—ãŸ','success');
}
function findFree(sz){
  const cv=document.getElementById('canvas'),cw=cv.clientWidth||800,gap=16,cols=Math.max(1,Math.floor(cw/(sz+gap)));
  for(let r=0;r<200;r++)for(let c=0;c<cols;c++){const x=gap+c*(sz+gap),y=gap+r*(sz+gap);if(!state.shortcuts.some(s=>!(x+sz<s.x||x>s.x+(s.w||120)||y+sz<s.y||y>s.y+(s.h||120))))return{x,y};}
  return{x:16,y:16};
}

// â”€â”€ Render â”€â”€
function renderCanvas(){
  const cv=document.getElementById('canvas');
  cv.querySelectorAll('.shortcut-btn,.empty-hint').forEach(e=>e.remove());
  if(!state.shortcuts.length){const h=document.createElement('div');h.className='empty-hint';h.innerHTML='<div class="icon">ğŸ“Œ</div><p>å·¦ã®ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚’è¿½åŠ <br>ç«¯ãƒ‰ãƒ©ãƒƒã‚°ã§ç§»å‹• / ä¸­å¤®ã‚¯ãƒªãƒƒã‚¯ã§ãƒªãƒ³ã‚¯</p>';cv.appendChild(h);return;}
  state.shortcuts.forEach(s=>{
    const el=document.createElement('div'),w=s.w||120,h=s.h||120;
    el.className='shortcut-btn';el.dataset.id=s.id;
    el.style.cssText=`left:${s.x}px;top:${s.y}px;width:${w}px;height:${h}px;background:linear-gradient(145deg,${s.color}DD,${s.color}88);`;
    el.innerHTML=`<div class="drag-zone"></div><div class="link-zone"></div><div class="drag-edge-indicator"></div><div class="sc-actions"><button class="sc-action-btn edit-btn" title="ç·¨é›†">âœ</button><button class="sc-action-btn delete delete-btn" title="å‰Šé™¤">âœ•</button></div><div class="sc-content"><div class="sc-icon">${s.icon}</div><div class="sc-name">${esc(s.name)}</div><div class="sc-category">${esc(s.category)}</div></div>`;
    el.querySelector('.drag-zone').addEventListener('mousedown',e=>{if(e.button===2)return;startDrag(el,e.clientX,e.clientY);e.preventDefault();});
    el.querySelector('.drag-zone').addEventListener('touchstart',e=>{const t=e.touches[0],rect=el.getBoundingClientRect(),rx=(t.clientX-rect.left)/rect.width,ry=(t.clientY-rect.top)/rect.height;if(rx>.2&&rx<.8&&ry>.2&&ry<.8)return;startDrag(el,t.clientX,t.clientY);e.preventDefault();},{passive:false});
    el.querySelector('.link-zone').addEventListener('click',e=>{e.stopPropagation();window.open(s.url,'_blank');});
    el.querySelector('.link-zone').addEventListener('touchend',e=>{if(!isDragging){e.preventDefault();window.open(s.url,'_blank');}});
    el.querySelector('.edit-btn').addEventListener('click',e=>{e.stopPropagation();editShortcut(s.id);});
    el.querySelector('.delete-btn').addEventListener('click',e=>{e.stopPropagation();deleteShortcut(s.id);});
    el.addEventListener('contextmenu',e=>{e.preventDefault();e.stopPropagation();ctxTargetId=s.id;showCtx(e.clientX,e.clientY);});
    cv.appendChild(el);
  });
}
function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML;}
function updateCount(){document.getElementById('countInfo').textContent=state.shortcuts.length+' å€‹';}

// â”€â”€ Drag â”€â”€
function startDrag(el,cx,cy){isDragging=true;dragEl=el;dragId=parseInt(el.dataset.id);const r=el.getBoundingClientRect();dragOffsetX=cx-r.left;dragOffsetY=cy-r.top;el.classList.add('dragging');}
function onMM(e){if(!isDragging||!dragEl)return;const cv=document.getElementById('canvas'),cr=cv.getBoundingClientRect();dragEl.style.left=Math.max(0,e.clientX-cr.left-dragOffsetX+cv.scrollLeft)+'px';dragEl.style.top=Math.max(0,e.clientY-cr.top-dragOffsetY+cv.scrollTop)+'px';}
function onMU(){if(!isDragging||!dragEl)return;isDragging=false;dragEl.classList.remove('dragging');const s=state.shortcuts.find(s=>s.id===dragId);if(s){s.x=parseInt(dragEl.style.left);s.y=parseInt(dragEl.style.top);saveToStorage();}dragEl=null;}
function onTM(e){if(!isDragging||!dragEl)return;e.preventDefault();const t=e.touches[0],cv=document.getElementById('canvas'),cr=cv.getBoundingClientRect();dragEl.style.left=Math.max(0,t.clientX-cr.left-dragOffsetX+cv.scrollLeft)+'px';dragEl.style.top=Math.max(0,t.clientY-cr.top-dragOffsetY+cv.scrollTop)+'px';}
function onTE(){if(!isDragging||!dragEl)return;isDragging=false;dragEl.classList.remove('dragging');const s=state.shortcuts.find(s=>s.id===dragId);if(s){s.x=parseInt(dragEl.style.left);s.y=parseInt(dragEl.style.top);saveToStorage();}dragEl=null;}

// â”€â”€ Context Menu â”€â”€
function showCtx(x,y){const m=document.getElementById('contextMenu');m.style.left=x+'px';m.style.top=y+'px';m.classList.add('show');}
function hideContextMenu(){document.getElementById('contextMenu').classList.remove('show');}
function ctxOpen(){const s=state.shortcuts.find(x=>x.id===ctxTargetId);if(s)window.open(s.url,'_blank');hideContextMenu();}
function ctxEdit(){editShortcut(ctxTargetId);hideContextMenu();}
function ctxDuplicate(){const s=state.shortcuts.find(x=>x.id===ctxTargetId);if(!s)return;state.shortcuts.push({...s,id:state.nextId++,x:s.x+20,y:s.y+20});saveToStorage();renderCanvas();updateCount();hideContextMenu();toast('è¤‡è£½ã—ã¾ã—ãŸ','success');}
function ctxDelete(){deleteShortcut(ctxTargetId);hideContextMenu();}

// â”€â”€ Edit â”€â”€
function editShortcut(id){
  const s=state.shortcuts.find(x=>x.id===id);if(!s)return;editingId=id;populateCatSelect();
  document.getElementById('editCat').value=s.category;document.getElementById('editName').value=s.name;document.getElementById('editUrl').value=s.url;
  document.getElementById('editSizeSlider').value=s.w||120;document.getElementById('editSizeLabel').textContent=s.w||120;
  editColor=s.color;editIcon=s.icon;
  rCP('editColorPicker',editColor,c=>{editColor=c;rCP('editColorPicker',editColor,arguments.callee);});
  rIP('editIconPicker',editIcon,i=>{editIcon=i;rIP('editIconPicker',editIcon,arguments.callee);});
  document.getElementById('editModal').classList.add('show');
}
function saveEdit(){const s=state.shortcuts.find(x=>x.id===editingId);if(!s)return;s.category=document.getElementById('editCat').value;s.name=document.getElementById('editName').value.trim();s.url=document.getElementById('editUrl').value.trim();s.color=editColor;s.icon=editIcon;s.w=parseInt(document.getElementById('editSizeSlider').value);s.h=s.w;saveToStorage();renderCanvas();closeEditModal();toast('æ›´æ–°ã—ã¾ã—ãŸ','success');}
function deleteEditing(){state.shortcuts=state.shortcuts.filter(s=>s.id!==editingId);saveToStorage();renderCanvas();updateCount();closeEditModal();toast('å‰Šé™¤ã—ã¾ã—ãŸ','success');}
function deleteShortcut(id){state.shortcuts=state.shortcuts.filter(s=>s.id!==id);saveToStorage();renderCanvas();updateCount();toast('å‰Šé™¤ã—ã¾ã—ãŸ','success');}
function closeEditModal(){document.getElementById('editModal').classList.remove('show');}

// â”€â”€ Category â”€â”€
function manageCats(){renderCatList();document.getElementById('catModal').classList.add('show');}
function closeCatModal(){document.getElementById('catModal').classList.remove('show');populateCatSelect();}
function renderCatList(){const el=document.getElementById('catList');el.innerHTML='';state.categories.forEach((c,i)=>{const r=document.createElement('div');r.className='cat-manage-row';r.innerHTML=`<span>${esc(c)}</span><button class="btn btn-sm btn-danger" onclick="removeCat(${i})">å‰Šé™¤</button>`;el.appendChild(r);});}
function addCategory(){const inp=document.getElementById('newCatInput'),nm=inp.value.trim();if(!nm)return;if(state.categories.includes(nm)){toast('æ—¢ã«å­˜åœ¨ã—ã¾ã™','error');return;}state.categories.push(nm);saveToStorage();renderCatList();inp.value='';toast('è¿½åŠ ã—ã¾ã—ãŸ','success');}
function removeCat(i){if(state.shortcuts.some(s=>s.category===state.categories[i])){toast('ä½¿ç”¨ä¸­ã¯å‰Šé™¤ä¸å¯','error');return;}state.categories.splice(i,1);saveToStorage();renderCatList();}

// â”€â”€ Export/Import JSON â”€â”€
function exportJSON(){const b=new Blob([JSON.stringify(state,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='shortcuts.json';a.click();toast('JSONãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†','success');}
function importData(){document.getElementById('importText').value='';document.getElementById('importFile').value='';document.getElementById('importModal').classList.add('show');}
function closeImportModal(){document.getElementById('importModal').classList.remove('show');}
function doImport(){
  const f=document.getElementById('importFile').files[0],t=document.getElementById('importText').value.trim();
  if(f){const r=new FileReader();r.onload=e=>{try{applyImport(JSON.parse(e.target.result));}catch(err){toast('JSONè§£æã‚¨ãƒ©ãƒ¼','error');}};r.readAsText(f);}
  else if(t){try{applyImport(JSON.parse(t));}catch(err){toast('JSONè§£æã‚¨ãƒ©ãƒ¼','error');}}
  else toast('å…¥åŠ›ã—ã¦ãã ã•ã„','error');
}
function applyImport(d){
  if(d.categories)state.categories=[...new Set([...state.categories,...d.categories])];
  if(d.shortcuts){const mx=state.shortcuts.reduce((m,s)=>Math.max(m,s.id),0);d.shortcuts.forEach((s,i)=>{s.id=mx+i+1;state.shortcuts.push(s);});state.nextId=state.shortcuts.reduce((m,s)=>Math.max(m,s.id),0)+1;}
  saveToStorage();populateCatSelect();renderCanvas();updateCount();closeImportModal();toast('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†','success');
}

function toast(msg,type='success'){const c=document.getElementById('toastContainer'),t=document.createElement('div');t.className='toast '+type;t.textContent=msg;c.appendChild(t);setTimeout(()=>t.remove(),3000);}

init();
</script>
</body>
</html>
